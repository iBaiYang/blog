---
layout: post
categories: Redis
title: Redis 通讯协议
meta: 通讯协议
---
* content
{:toc}

### 正文

在Yii2的一个项目中，使用了yii2-redis包，用起来挺方便，就想看一下原理，追踪到执行的代码：
```
public function executeCommand($name, $params = [])
{
    $this->open();

    array_unshift($params, $name);
    $command = '*' . count($params) . "\r\n";
    foreach ($params as $arg) {
        $command .= '$' . mb_strlen($arg, '8bit') . "\r\n" . $arg . "\r\n";
    }

    \Yii::trace("Executing Redis Command: {$name}", __METHOD__);
    fwrite($this->_socket, $command);

    return $this->parseResponse(implode(' ', $params));
}
```

fwrite()是向redis写入数据，发现$command却是一串字符：
```
*3\r\n$3\r\nSET\r\n$5\r\nmykey\r\n$7\r\nmyvalue\r\n
```

有些看不懂了，Redis不是key-value数据库吗？怎么这里是一串字符？key去哪了？

翻阅好多资料后，才知道这是Redis的通讯协议规定的格式，里面已经包含了key和value。

#### Redis 通讯协议 请求

新的统一请求协议

新的统一协议已在Redis 1.2中引入，但是在Redis 2.0中，这就成为了与Redis服务器通讯的标准方式。

在这个统一协议里，发送给Redis服务端的所有参数都是二进制安全的。以下是通用形式：
```
*<number of arguments> CR LF
$<number of bytes of argument 1> CR LF
<argument data> CR LF
...
$<number of bytes of argument N> CR LF
<argument data> CR LF
```

说明：

    *开头，表示有多少个参数，例如*3表示有3个参数（set, name, wu）

    $开头，表示参数的字节长度，例如$3表示set有3个字节，$4表示name有4个字节

    每行rn结尾

如我们上面看到的：
```
*3\r\n$3\r\nSET\r\n$5\r\nmykey\r\n$7\r\nmyvalue\r\n
```

就是 SET 设置 mykey =》 myvalue

SET可以换为其他的redis命令，如 GET、INCR、RPUSH、HMSET、MULTI、HDEL、LINSERT、LREM、RENAME、EXEC 等。

#### Redis 通讯协议 回复

Redis用不同的回复类型回复命令。它可能从服务器发送的第一个字节开始校验回复类型：

    用单行回复，回复的第一个字节将是“+”
    
    错误消息，回复的第一个字节将是“-”
    
    整型数字，回复的第一个字节将是“:”
    
    批量回复，回复的第一个字节将是“$”
    
    多个批量回复，回复的第一个字节将是“*”
    
有的地方翻译的叫法不同：

    状态回复（status reply）的第一个字节是 "+"，例如+OK\r\n

    错误回复（error reply）的第一个字节是 "-"，例如-No such key\r\n

    整数回复（integer reply）的第一个字节是 ":"，例如:1\r\n

    批量回复（bulk reply）的第一个字节是 "$"，例如 $5\r\nwuzhc\r\n

    多条批量回复（multi bulk reply）的第一个字节是 "*"，例如*2\r\n$5\r\nwuzhc\r\n$3r\nage\r\n

    
Simple Strings单行回复

状态回复（或者单行回复）以“+”开始以“\r\n”结尾的单行字符串形式。例如：

"+OK\r\n"

客户端库将在“+”后面返回所有数据，正如上例中字符串“OK”一样。

其他回复，我们看一下yii2-redis中对回复的处理就知道了：
```
private function parseResponse($command)
{
    if (($line = fgets($this->_socket)) === false) {
        throw new Exception("Failed to read from socket.\nRedis command was: " . $command);
    }
    $type = $line[0];
    $line = mb_substr($line, 1, -2, '8bit');
    switch ($type) {
        case '+': // Status reply
            if ($line === 'OK' || $line === 'PONG') {
                return true;
            } else {
                return $line;
            }
        case '-': // Error reply
            throw new Exception("Redis error: " . $line . "\nRedis command was: " . $command);
        case ':': // Integer reply
            // no cast to int as it is in the range of a signed 64 bit integer
            return $line;
        case '$': // Bulk replies
            if ($line == '-1') {
                return null;
            }
            $length = $line + 2;
            $data = '';
            while ($length > 0) {
                if (($block = fread($this->_socket, $length)) === false) {
                    throw new Exception("Failed to read from socket.\nRedis command was: " . $command);
                }
                $data .= $block;
                $length -= mb_strlen($block, '8bit');
            }

            return mb_substr($data, 0, -2, '8bit');
        case '*': // Multi-bulk replies
            $count = (int) $line;
            $data = [];
            for ($i = 0; $i < $count; $i++) {
                $data[] = $this->parseResponse($command);
            }

            return $data;
        default:
            throw new Exception('Received illegal data from redis: ' . $line . "\nRedis command was: " . $command);
    }
}
```

<br/><br/><br/><br/><br/>
### 参考资料

Redis 通讯协议 <https://segmentfault.com/a/1190000011145207>

Redis protocol <http://redis.cn/topics/protocol.html>

Yii2.0源码阅读-PHP如何与redis通信？  <https://www.cnblogs.com/skyfynn/p/8980322.html>

Yii2.0源码阅读-PHP如何与redis通信？ <https://www.bbsmax.com/A/n2d9bQb6zD/>

Yii 2 Redis 缓存，会话和活动记录 <https://github.com/yiisoft/yii2-redis/tree/master/docs/guide-zh-CN>

yii2-redis 扩展详解 <https://www.yiichina.com/doc/guide/2.0/yii2-redis>


---
layout: post
categories: Yii2
title: 深入理解Yii2.0 附录解读
meta: 附录1：Yii2.0 对比 Yii1.1 的重大改进、附录2：Yii的安装
---
* content
{:toc}

### 附录1：Yii2.0 对比 Yii1.1 的重大改进

1. PHP新特性
2. 命名空间(Namespace)
3. 基础类
4. 事件(Event)
5. 别名(Alias)
6. 视图(View)
7. 模型(Model)
8. 控制器(Controller)
9. Active Record


Yii2.0中使用到的PHP新特性，主要有：

* 命名空间(Namespace)
* 匿名函数
* 数组短语法形式： [1,2,3] 取代 array(1,2,3) 。这在多维数组、嵌套数组中，代码更清晰、简短。
* 在视图文件中使用PHP的 <?= 标签，取代 echo 语句。
* 标准PHP库(SPL) 类和接口，具体可以查看 SPL Class and Interface <https://php.net/manual/en/book.spl.php>
* 延迟静态绑定， 具体可以查看 Late Static Bindings <https://php.net/manual/en/language.oop5.late-static-bindings.php>
* PHP标准日期时间 <https://php.net/manual/en/book.datetime.php>
* 特性(Traits) <https://php.net/manual/en/language.oop5.traits.php>
* 使用PHP intl 扩展实现国际化支持， 具体可以查看 PECL init <https://php.net/manual/en/book.intl.php>

### 附录2：Yii的安装

#### 使用Composer安装Yii

Yii2.0要求Composer必须安装 composer asset 插件。 这个插件使得Composer可以兼容实现NPM和BOWER包管理器的功能。 
NPM 和 BOWER 主要用于前端资源（如JS库等）的管理。

```
# 安装Composer，如果已经安装过，可不必再安装
# curl -s http://getcomposer.org/installer | php

# 对于已经安装过Composer的，可以对其进行更新
php ../composer.phar self-update

# 为Composer 安装 composer asset 插件
php ../composer.phar global require "fxp/composer-asset-plugin:1.0.0-beta2"

# 使用高级模版安装Yii应用到 digpage.com 目录下
php ../composer.phar create-project --prefer-dist yiisoft/yii2-app-advanced webname

# 使用基础模版安装
# composer create-project --prefer-dist yiisoft/yii2-app-basic webname
```

如果想使用最新的开发版本的Yii基础模版，可加入 --stability=dev 参数。

#### 从压缩包安装

1. 从yiiframework.com下载最新的压缩包。

2. 将压缩包解压缩到 /path/to/digpage.com 目录。

3. 修改 config/web.php 文件，输入 cookieValidationKey 配置项密钥。 这个密钥主要用于cookie验证。 
如果使用Composer安装，则Composer会自动设置一个密钥:

```
// !!! insert a secret key in the following (if it is empty) -
// this is required by cookie validation
'cookieValidationKey' => 'enter your secret key here',
```

#### 设置Web服务器

常用的Web服务器有nginx + php-fpm 和 Apache。

由于是在本地开发，我们使用不同的端口来分离前台和后台。 体现在服务器上，采不同主机名、端口进行的分离方式，意味着不同的虚拟主机，
甚至是不同的物理服务器。 而不同的路径名的，则表现为同一台主机，不同目录。 这里，我们使用不同的端口来区别前后台，但在物理上，
前端和后端面都部署在同一台服务器上，也就是使用虚拟主机。

使用Nginx的配置如下：
```
# for frontend
server {
    charset utf-8;
    client_max_body_size 128M;

    listen 80; ## listen for ipv4

    server_name localhost;
    root        /path/to/digpage.com/frontend/web;
    index       index.php;

    access_log  /path/to/digpage.com/frontend/log/access.log main;
    error_log   /path/to/digpage.com/frontend/log/error.log;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        include fastcgi.conf;
        fastcgi_pass   127.0.0.1:9000;
    }

    location ~ /\.(ht|svn|git) {
        deny all;
    }
}

# for backend
server {
    # ...other settings...
    listen 81;
    server_name localhost;
    root /path/to/digpage.com/backend/web;
    # ...other settings...
}
```

在linux下安装nginx后配置项目，我们可以在项目放到/var/www/目录下，然后在这个目录下新建一个目录vhost用于存放项目访问的nginx配置文件。
我们修改nginx对项目的根配置文件/etc/nginx/nginx.conf如下：
```
user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 768;
    # multi_accept on;
}

http {

    ##
    # Basic Settings
    ##

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    # server_tokens off;

    # server_names_hash_bucket_size 64;
    # server_name_in_redirect off;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    ##
    # SSL Settings
    ##

    ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE
    ssl_prefer_server_ciphers on;

    ##
    # Logging Settings
    ##

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    ##
    # Gzip Settings
    ##

    gzip on;
    gzip_disable "msie6";

    # gzip_vary on;
    # gzip_proxied any;
    # gzip_comp_level 6;
    # gzip_buffers 16 8k;
    # gzip_http_version 1.1;
    # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    ##
    # Virtual Host Configs
    ##

    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
    include /var/www/vhost/*.conf;
}


#mail {
#    # See sample authentication script at:
#    # http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript
# 
#    # auth_http localhost/auth.php;
#    # pop3_capabilities "TOP" "USER";
#    # imap_capabilities "IMAP4rev1" "UIDPLUS";
# 
#    server {
#        listen     localhost:110;
#        protocol   pop3;
#        proxy      on;
#    }
# 
#    server {
#        listen     localhost:143;
#        protocol   imap;
#        proxy      on;
#    }
#}
```

其实就是增加了这一行：
```
include /var/www/vhost/*.conf;
```

然后我们看一下一个项目配置/var/www/vhost/admin.com.conf的例子：
```
server {
    charset utf-8;
    client_max_body_size 128M;

    listen 80; ## listen for ipv4
    #listen [::]:80 default_server ipv6only=on; ## listen for ipv6

    server_name admin.com;
    root        /var/www/Admin/admin/web;
    index       index.php;

    access_log  /var/www/log/access/admin.com.log;
    error_log   /var/www/log/error/admin.com.log;

    location / {
        # Redirect everything that isn't a real file to index.php
        try_files $uri $uri/ /index.php$is_args$args;
    }

    # uncomment to avoid processing of calls to non-existing static files by Yii
    #location ~ \.(js|css|png|jpg|gif|swf|ico|pdf|mov|fla|zip|rar)$ {
    #    try_files $uri =404;
    #}
    #error_page 404 /404.html;

    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        #fastcgi_pass 127.0.0.1:9000;
        fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
        try_files $uri =404;
    }

    location ~* /\. {
        deny all;
    }
}
```

#### Yii中的前后台
     
Yii从来不认得什么是前台，什么是后台。从本质来讲，前台和后台都是应用。 

总的说，Yii的前台、后台什么的，是我们命名的概念，他们都是独立而完备的应用。 同时，他们又都具有一定的联系，
这些联系突出体现在了 common 目录上。 这个目录从字面的意思看，就是通用，对于组织到一起的 frontend backend console 而言， 
common 中的内容，他们都可以使用。这是Yii中实现代码复用的技巧所在。

#### 配置应用环境

环境就是指开发环境、测试环境、产品环境等。 对于Yii而言，所谓的环境，就是一组与运行环境相关的配置文件和入口脚本。

Yii对于环境的使用是这样一个原理：采用一个自动化的脚本，每次需要切换环境时，就运行脚本， 由开发者确定要采用何种环境，
然后将对应环境的所有配置文件都覆盖当前的配置文件。 
在Yii中，与环境相关的文件其实就只有两个：一个是入口脚本 index.php 另一个就是各类配置文件。

在切换环境时，只需要一行命令就全部搞定：
```
php /path/to/webname/init
```

这行命令会提示你选择何种开发环境，并确认是否覆盖当前的配置文件。下面是输出的内容：
```
Yii Application Initialization Tool v1.0

Which environment do you want the application to be initialized in?

  [0] Development
  [1] Production

  Your choice [0-1, or "q" to quit] 0    // 这里选择了 Development 环境

  Initialize the application under 'Development' environment? [yes|no] yes

  Start initialization ...

   generate yii
   generate common/config/main-local.php
   generate common/config/params-local.php
   generate backend/config/main-local.php
   generate backend/config/params-local.php
   generate backend/web/index.php
   generate backend/web/index-test.php
   generate frontend/config/main-local.php
   generate frontend/config/params-local.php
   generate frontend/web/index.php
   generate frontend/web/index-test.php
   generate console/config/main-local.php
   generate console/config/params-local.php
   generate cookie validation key in backend/config/main-local.php
   generate cookie validation key in frontend/config/main-local.php
      chmod 0777 backend/runtime
      chmod 0777 backend/web/assets
      chmod 0777 frontend/runtime
      chmod 0777 frontend/web/assets
      chmod 0755 yii

  ... initialization completed.
```

从上面的输出可以看出来， init 脚本其实做了3件事：

* 复制文件到相应位置，覆盖当前配置。
* 生成 cookieValidationKey 并写入相应文件。
* 设置相关文件和目录的权限。

如果想更加便捷，可以直接指定相关的参数：
```
php /path/to/yii-application/init --env=Production overwrite=All
```

#### 检验安装情况

我们已经完成了Yii的安装，可能使用了Composer，也可能使用了压缩包。 接着，我们配置好了Web服务器。 最后，我们运行了 init 命令。 
那么，Yii应用的基本框架就已经搭建好了。你可在你的浏览器中试试效果。 
使用 http://localhost:80/ 可以打开网站前台，使用 http://localhost:81 可以打开后台。

#### 附图

![](https://raw.githubusercontent.com/iBaiYang/PictureWareroom/master/20190708/20190708110934.png)

![](https://raw.githubusercontent.com/iBaiYang/PictureWareroom/master/20190708/20190708110935.png)

<br/><br/><br/><br/><br/>
### 参考资料

深入理解Yii2.0 » 附录 » 附录1：Yii2.0 对比 Yii1.1 的重大改进  <http://www.digpage.com/improvement.html>

深入理解Yii2.0 » 附录 » 附录2：Yii的安装 <http://www.digpage.com/install.html>


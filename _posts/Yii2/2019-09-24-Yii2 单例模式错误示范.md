---
layout: post
categories: Yii2
title: Yii2 单例模式错误示范
meta: 单例模式错误示范
---
* content
{:toc}

### 正文

一次在项目中：

```
"components" => [
    'queueNew' => [
        "class" =>  'common\components\LRabbitQueue',
        'credentials'   => [
            'host' => '192.168.0.1',
            'port' => '5672',
            'login' => 'mqadmin',
            'password' => 'mqadmin'
        ]
    ],
],
```

```
<?php
namespace common\components;

use Yii;
use yii\base\Component;

class LRabbitQueue extends Component
{
    const LOG_PREFIX = 'common.components.LRedisCache.';
    private $connection;
    public $credentials;

    
    public function init()
    {

    }

    /**
     * 初始化连接
     */
    public function initConnection()
    {
        if (!$this->connection || !is_resource($this->connection)) {
            $this->connection = new \AMQPConnection(Yii::$app->queue->credentials);
        }
        if (!$this->connection->isConnected()) {
            $this->connect();
        }
    }

    public function connect($tryNum=3) {
        try {
            $this->connection->connect();
        }
        catch(\Exception $e) {
            if (--$tryNum) {
                Yii::warning("msg[".$e->getMessage()."]", self::LOG_PREFIX . __FUNCTION__);
                sleep(1);
                $this->connect($tryNum);
            } else {
                Yii::error("msg[".$e->getMessage()."]", self::LOG_PREFIX . __FUNCTION__);
                throw $e;
            }
        }

    }
    
    public function getConnection() {
        $this->initConnection();
        return $this->connection;
    }

    /**
     * 日志进队
     * @param $message
     * @param $exchange
     * @param $routing
     * @return bool
     */
    public function produce($message, $exchange, $routing)
    {
        $message = json_encode($message);

        $channel = new \AMQPChannel($this->getConnection());
        $ex = new \AMQPExchange($channel);
        $ex->setName($exchange);
        $ex->setType(AMQP_EX_TYPE_DIRECT);
        $ex->setFlags(AMQP_DURABLE);

        $ex->declareExchange();

        if (!$ex->publish($message, $routing, 1, ['delivery_mode' => 2])) {
            return false;
        }

        return true;
    }

    public function batchProduce($messageList, $exchange, $routing)
    {
        $channel = new \AMQPChannel($this->getConnection());
        $ex = new \AMQPExchange($channel);
        $ex->setName($exchange);
        $ex->setType(AMQP_EX_TYPE_DIRECT);
        $ex->setFlags(AMQP_DURABLE);

        $ex->declareExchange();

        foreach ($messageList as $message) {
            $messageJson = json_encode($message);

            if (!$ex->publish($messageJson, $routing, 1, ['delivery_mode' => 2])) {
                return false;
            }
        }

        return true;
    }

    /**
     * @param $message
     * @param $exchange
     * @param $routing
     * @param $ttl    消息生存时间(1000 = 1s)
     * @return bool
     * @created by Jhu
     * 通用延迟消费进队方法,消息持久化
     */
    public function produceTtl($message, $exchange, $routing, $ttl)
    {

        $message = json_encode($message);

        $channel = new \AMQPChannel($this->getConnection());
        $ex = new \AMQPExchange($channel);
        $ex->setName($exchange);
        $ex->setType(AMQP_EX_TYPE_DIRECT);
        $ex->setFlags(AMQP_DURABLE);

        $ex->declareExchange();

        $argument = array(
            'delivery_mode' => 2,
            'expiration' => $ttl
        );

        if (!$ex->publish($message, $routing, 1, $argument)) {
            return false;
        }

        return true;
    }
}
```

```
<?php
namespace common\components;

use Yii;
use yii\base\Component;

class LRabbitQueue extends Component
{
    const LOG_PREFIX = 'common.components.LRedisCache.';
    private $connection;
    public $credentials;

    
    public function init()
    {
        parent::init();
        $this->connection = new \AMQPConnection($this->credentials);
    }

    public function connect($tryNum=3) {
        try {
            $this->connection->connect();
        }
        catch(\Exception $e) {
            if (--$tryNum) {
                Yii::warning("msg[".$e->getMessage()."]", self::LOG_PREFIX . __FUNCTION__);
                sleep(1);
                $this->connect($tryNum);
            } else {
                Yii::error("msg[".$e->getMessage()."]", self::LOG_PREFIX . __FUNCTION__);
                throw $e;
            }
        }
    }
    
    public function getConnection()
    {
        if (!$this->connection->isConnected()) {
            $this->connect();
        }
        return $this->connection;
    }

    /**
     * 日志进队
     * @param $message
     * @param $exchange
     * @param $routing
     * @return bool
     */
    public function produce($message, $exchange, $routing)
    {
        $message = json_encode($message);

        $channel = new \AMQPChannel($this->getConnection());
        $ex = new \AMQPExchange($channel);
        $ex->setName($exchange);
        $ex->setType(AMQP_EX_TYPE_DIRECT);
        $ex->setFlags(AMQP_DURABLE);

        $ex->declareExchange();

        if (!$ex->publish($message, $routing, 1, ['delivery_mode' => 2])) {
            return false;
        }

        return true;
    }

    public function batchProduce($messageList, $exchange, $routing)
    {
        $channel = new \AMQPChannel($this->getConnection());
        $ex = new \AMQPExchange($channel);
        $ex->setName($exchange);
        $ex->setType(AMQP_EX_TYPE_DIRECT);
        $ex->setFlags(AMQP_DURABLE);

        $ex->declareExchange();

        foreach ($messageList as $message) {
            $messageJson = json_encode($message);

            if (!$ex->publish($messageJson, $routing, 1, ['delivery_mode' => 2])) {
                return false;
            }
        }

        return true;
    }

    /**
     * @param $message
     * @param $exchange
     * @param $routing
     * @param $ttl    消息生存时间(1000 = 1s)
     * @return bool
     * @created by Jhu
     * 通用延迟消费进队方法,消息持久化
     */
    public function produceTtl($message, $exchange, $routing, $ttl)
    {

        $message = json_encode($message);

        $channel = new \AMQPChannel($this->getConnection());
        $ex = new \AMQPExchange($channel);
        $ex->setName($exchange);
        $ex->setType(AMQP_EX_TYPE_DIRECT);
        $ex->setFlags(AMQP_DURABLE);

        $ex->declareExchange();

        $argument = array(
            'delivery_mode' => 2,
            'expiration' => $ttl
        );

        if (!$ex->publish($message, $routing, 1, $argument)) {
            return false;
        }

        return true;
    }
}
```

<br/><br/><br/><br/><br/>
### 参考资料

PHP 常用设计模式-单例模式 <https://ibaiyang.github.io/blog/php/2019/07/30/PHP-%E5%B8%B8%E7%94%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html#%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8Fsingleton>

深入理解Yii2.0 依赖注入和依赖注入容器 <https://ibaiyang.github.io/blog/yii2/2019/06/28/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Yii2.0-%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E5%92%8C%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E5%AE%B9%E5%99%A8.html>

深入理解Yii2.0 服务定位器 <https://ibaiyang.github.io/blog/yii2/2019/06/29/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Yii2.0-%E6%9C%8D%E5%8A%A1%E5%AE%9A%E4%BD%8D%E5%99%A8.html>







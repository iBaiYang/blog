---
layout: post
categories: Yii2
title: Yii2 四种缓存的使用 
meta: Yii2 四种缓存的使用 
---
* content
{:toc}

### 正文

yii2的四种缓存是：
* 数据缓存
* 片段缓存
* 页面缓存
* HTTP 缓存

#### 1、数据缓存的使用例子：

在相应的试图view中，

>  use yii\caching\DbDependency; 

然后

```php
// 数据缓存示例
$data = Yii::$app->cache->get('postCount');
$dependency = new DbDependency( ['sql' => 'select count(id) from post'] );

if ( $data === false ) {
    $data = Post::find()->count();
    Yii::$app->cache->set('postCount', $data, 600, $dependency);
}

echo $data; 
```

![](http://s15.sinaimg.cn/mw690/001XbchKzy7fdl9VEbY6e&690)

![](http://s14.sinaimg.cn/mw690/001XbchKzy7fdlwAMuV3d&690)

![](http://s8.sinaimg.cn/mw690/001XbchKzy7fdlFPGoDb7&690)

#### 2、片段缓存的使用例子：

在相应的试图view中，

>  use yii\caching\DbDependency; 

然后

```php
// 片段缓存示例
$dependency = new DbDependency( ['sql' => 'select count(id) from post'] );

if ( $this->beginCache('cache', ['duration' => 300], ['dependency' => $dependency]) ) {
    echo TagsCloudWidget::widget(['tags'=>$tags]);
    $this->endCache();
} 
```

![](http://s2.sinaimg.cn/mw690/001XbchKzy7fdlczd5L61&690)

![](http://s3.sinaimg.cn/mw690/001XbchKzy7fdlPW1d8b2&690)

上面两个完整页面示例代码地址：

<https://github.com/iBaiYang/yii2_weixi/blob/master/frontend/views/post/index.php>

#### 3、页面缓存的使用例子：

在相应的控制器的behaviors中：

```php
// 页面缓存
'pageCache' => [
    'class' => 'yii\filters\PageCache',
    'only' => ['index'],
    'duration' => 150,
    'variations' => [
        Yii::$app->request->get('page'),
        Yii::$app->request->get('PostSearch'),
        // Yii::$app->language,
    ],
    'dependency' => [
        'class' => 'yii\caching\DbDependency',
        'sql' => 'select count(id) from post',
    ],
], 
```

![](http://s9.sinaimg.cn/mw690/001XbchKzy7fdlUczj268&690)

#### 4、HTTP 缓存的使用例子：

在相应的控制器的behaviors中：

```php
 // HTTP缓存
'httpCache' => [
    'class' => 'yii\filters\HttpCache',
    'only' => ['detail'],
    'lastModified' => function ( $action, $params ) {
        $q = new \yii\db\Query();
        return $q->from('post')->max('update_time');
    },
    'etagSeed' => function ( $action, $params ) {
        $post = $this->findModel( Yii::$app->request->get('id') );
        return serialize( [$post->title, $post->content] );
    },
    'cacheControlHeader' => 'public, max-age=600',
], 
```

![](http://s4.sinaimg.cn/mw690/001XbchKzy7fdlZwTIv93&690)

这两个的完整页面示例代码地址：

<https://github.com/iBaiYang/yii2_weixi/blob/master/frontend/controllers/PostController.php>

![](http://s16.sinaimg.cn/mw690/001XbchKzy7fdmmGSJhdf&690)

![](http://s9.sinaimg.cn/mw690/001XbchKzy7fdmmKARi68&690)

![](http://s14.sinaimg.cn/mw690/001XbchKzy7fdmmO7bTcd&690)

![](http://s5.sinaimg.cn/mw690/001XbchKzy7fdmmRzKc74&690)

![](http://s15.sinaimg.cn/mw690/001XbchKzy7fdmmWCVU2e&690)

![](http://s11.sinaimg.cn/mw690/001XbchKzy7fdmmZfmy2a&690)




<br/><br/><br/><br/><br/>
### 参考资料 

<http://www.yiichina.com/doc/guide/2.0/caching-overview>

<http://www.weixistyle.com/yii2.php>


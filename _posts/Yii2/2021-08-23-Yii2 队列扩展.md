---
layout: post
categories: Yii2
title: Yii2 队列扩展
meta: Yii2 队列扩展
---
* content
{:toc}

## 正文

碰到一个项目中用 Yii2 队列扩展 实现的MySQL队列，入队的地方看明白了，但消费的地方理解了好长时间，这里记录一下。

### 配置

如果要使用这个扩展必须向下面这样配置它：
```
return [
    'bootstrap' => [
        'queue', // 把这个组件注册到控制台
    ],
    'components' => [
        'queue' => [
            'class' => \yii\queue\<driver>\Queue::class,
            'as log' => \yii\queue\LogBehavior::class,  // 事件日志
            // 驱动的其他选项
        ],
    ],
];
```

`<driver>`是驱动名称，如 db、redis 等。

每个被发送到队列的任务应该被定义为一个单独的类。 例如，如果您需要下载并保存一个文件，该类可能看起来如下：
```
class DownloadJob extends BaseObject implements \yii\queue\JobInterface
{
    public $url;
    public $file;
    
    public function execute($queue)
    {
        file_put_contents($this->file, file_get_contents($this->url));
    }
}
```

### 入队

下面是将任务添加到队列:
```
Yii::$app->queue->push(new DownloadJob([
    'url' => 'http://example.com/image.jpg',
    'file' => '/tmp/image.jpg',
]));
```

将作业推送到队列中延时5分钟运行:
```
Yii::$app->queue->delay(5 * 60)->push(new DownloadJob([
    'url' => 'http://example.com/image.jpg',
    'file' => '/tmp/image.jpg',
]));
```

### 消费

#### DB 驱动

DB 驱动使用库存储队列数据。

配置示例：
```
return [
    'bootstrap' => [
        'queue', // 把这个组件注册到控制台
    ],
    'components' => [
        'db' => [
            'class' => \yii\db\Connection::class, 
            // ...
        ],
        'queue' => [
            'class' => \yii\queue\db\Queue::class,
            'db' => 'db', // DB 连接组件或它的配置
            'tableName' => '{{%queue}}', // 表名
            'channel' => 'default', // Queue channel key
            'mutex' => \yii\mutex\MysqlMutex::class, // Mutex that used to sync queries
        ],
    ],
];
```

需要先向数据库添加一个表。MySQL示例语句：
```
CREATE TABLE `queue` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `channel` varchar(255) NOT NULL,
  `job` blob NOT NULL,
  `pushed_at` int(11) NOT NULL,
  `ttr` int(11) NOT NULL,
  `delay` int(11) NOT NULL DEFAULT 0,
  `priority` int(11) unsigned NOT NULL DEFAULT 1024,
  `reserved_at` int(11) DEFAULT NULL,
  `attempt` int(11) DEFAULT NULL,
  `done_at` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `channel` (`channel`),
  KEY `reserved_at` (`reserved_at`),
  KEY `priority` (`priority`)
) ENGINE=InnoDB;
```

消费者脚本命令，监听和处理队列任务：
> yii queue/listen

队列中有数据，执行Job中的`execute()`方法。

获取并执行循环中的任务，直到队列为空
> yii queue/run

打印关于队列状态的信息
> yii queue/info



<br/><br/><br/><br/><br/>
## 参考资料

Yii2 队列扩展 基本使用 <https://www.yiiframework.com/extension/yiisoft/yii2-queue/doc/guide/2.0/zh-cn/usage>

Yii2 队列扩展 DB 驱动 <https://www.yiiframework.com/extension/yiisoft/yii2-queue/doc/guide/2.0/zh-cn/driver-db>

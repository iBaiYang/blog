---
layout: post
categories: Yii2
title: Yii2 kafka使用
meta: kafka可以用来记录日志等。
---
* content
{:toc}

#### 正文

kafka可以用来记录日志等，这里重点讲Yii2中怎么使用。

composer.php文件内容
```
{
    "name": "yiisoft/yii2-app-basic",
    "description": "Yii 2 Basic Project Template",
    "keywords": ["yii2", "framework", "basic", "project template"],
    "homepage": "http://www.yiiframework.com/",
    "type": "project",
    "license": "BSD-3-Clause",
    "support": {
        "issues": "https://github.com/yiisoft/yii2/issues?state=open",
        "forum": "http://www.yiiframework.com/forum/",
        "wiki": "http://www.yiiframework.com/wiki/",
        "irc": "irc://irc.freenode.net/yii",
        "source": "https://github.com/yiisoft/yii2"
    },
    "repositories": {
        "packagist": {
            "type": "composer",
            "url": "https://packagist.phpcomposer.com"
        }
    },
    "minimum-stability": "stable",
    "require": {
        "php": ">=7.0.0",
        "yiisoft/yii2": "=2.0.8",
        "nmred/kafka-php": "0.2.*",
        "lcobucci/jwt": "^3.2",
        "qiniu/php-sdk": "^7.2"
    },
    "config": {
        "process-timeout": 1800
    }
}
```

可以看到里面有kafka。

\public\index.php 入口文件
```
<?php
if (isset($_SERVER['HTTP_ORIGIN'])) {
    header("Access-Control-Allow-Credentials: true");
    header("Access-Control-Allow-Origin: *");
    header("Access-Control-Allow-Headers: *, X-Requested-With, Content-Type, jwt-token");
}

// 选择环境（dev、pre、prod）
if ( file_exists(__DIR__ . '/../env-dev.php') ) {
    define('ENV_CONFIG', 'dev');
} elseif ( file_exists(__DIR__ . '/../env-pre.php') ) {
    define('ENV_CONFIG', 'pre');
} else {
    define('ENV_CONFIG', 'prod');
}
// 调试配置
if (ENV_CONFIG === 'dev' || ENV_CONFIG === 'pre')
{
    defined('YII_DEBUG') or define('YII_DEBUG', true);
    defined('YII_ENV') or define('YII_ENV', 'dev');
}

$logId = uniqid() . mt_rand(100000, 999999);
require(__DIR__ . '/../vendor/autoload.php');
require(__DIR__ . '/../vendor/yiisoft/yii2/Yii.php');
require(__DIR__."/../common/components/LApplication.php");
$config = include_once(__DIR__ . "/../backend/config/dev.php");

//向容器注册接口
require(__DIR__ . '/reg.php');

$application = new common\components\LApplication($config);
$application->run();
```

\backend\config\dev.php内容：
```
<?php
$commonConfig = include(__DIR__ . '/../../common/config/'. ENV_CONFIG .'.php');
$baseConfig = include('base.php');

$config = yii\helpers\ArrayHelper::merge($commonConfig, $baseConfig);

return $config;
```

\common\config\dev.php内容有：
```
<?php
$baseConfig = include('base.php');

$commonConfig = [
    'components' => [
        'log' => [
            'targets' => [
                'kafka'  => [
                    'levels' => ['error', 'warning'],
                    'logVars'=>[],
                ],
            ]
        ],
        'kafkaProducer' =>  [
            "metadata"  =>  [
                "brokerList"    => "192.168.10.111:9092",
                // "brokerList"    => "192.168.10.111:9092,192.168.10.115:9092,192.168.10.119:9092",  // kafka集群
            ],
            "requireAck"    =>  0,
        ],
        // 以下省略若干
    ],
    'params' => [
        'elkIndexName'  => [
            "error" =>  "error_abc_log",
            "warning" =>  "abc_log",
            "info" =>  "abc_log",
        ],
        // 以下省略若干
    ],
];

return yii\helpers\ArrayHelper::merge($baseConfig, $commonConfig);
```

prod.php 与dev.php类似。

\common\config\base.php配置文件中有：
```
<?php
return [
    'aliases' => [
        '@common' => realpath(__DIR__."/../"),
    ],
    'bootstrap' => ['log'],
    'components' => [
        'errorHandler'  => [
            'class' => 'common\components\LErrorHandler',
        ],
        'log' => [
            'targets' => [
                'kafka'  => [
                    'class' => 'common\lib\LKafkaTarget',
                ],
            ],
        ],
        'kafkaProducer' => [
            "class" =>  'common\components\LKafkaProducerQueue'
        ],
        'queue' =>  [
            "class" =>  'common\components\LRabbitQueue'
        ],
    ],
    // 以下省略若干
];
```

\common\lib\LKafkaTarget.php 内容
```
<?php
namespace common\lib;

use Yii;
use yii\log\Logger;
use yii\log\Target;
use common\components\LKafkaProducerQueue;

class LKafkaTarget extends Target
{
    /** @var  LKafkaProducerQueue */
    public $kafkaProducer;

    public function init()
    {
        parent::init();
        $this->kafkaProducer = Yii::$app->get("kafkaProducer");
    }

    /**
     * Exports log [[messages]] to a specific destination.
     * Child classes must implement this method.
     */
    public function export()
    {
        // TODO: Implement export() method.
        $text = array_map([$this, 'formatMessage'], $this->messages);

        $this->kafkaProducer->send( $text );
    }

    /**
     * Formats a log message for display as a string.
     * @param array $message the log message to be formatted.
     * The message structure follows that in [[Logger::messages]].
     * @return string the formatted message
     */
    public function formatMessage( $message )
    {
        list( $text, $level, $category, $timestamp ) = $message;

        $indexname = "abc_log";
        $level = Logger::getLevelName( $level );
        $elkIndexName = Yii::$app->params['elkIndexName'];
        if ( isset($elkIndexName[ $level ]) ) {
            $indexname = $elkIndexName[ $level ];
        }

        global $logId;
        $data = [
            "log_id"    => $logId,
            "indexname" => $indexname,
            "time"      => date('Y-m-d H:i:s', $timestamp),
            "category"  => $category,
            "level"     => $level,
            "ip_address"=> Yii::$app->request->getUserHostAddress()
        ];
        if ( !is_string( $text ) ) {
            // exceptions may not be serializable if in the call stack somewhere is a Closure
            if ( $text instanceof \Throwable || $text instanceof \Exception ) {
                $text = (string) $text;
                $data['msg'] = $text;
            } elseif ( is_array($text) ) {
                if ( isset($text['log_id']) ) {
                    unset( $text['log_id'] );
                }

                $data = array_merge( $data, $text );
            }
        }

        $traces = [];
        if ( isset($message[4]) ) {
            foreach ( $message[4] as $trace )
            {
                $traces[] = "in {$trace['file']}:{$trace['line']}";
            }
        }
        if ( $traces ) {
            $data['traces'] = $traces;
        }

        return [
            "topic" =>  "logstash",
            "value" =>  json_encode( $data ),
            "key" => "test"
        ];
    }
}
```

\common\components\LKafkaProducerQueue.php 内容
```php
<?php
namespace common\components;

use Kafka\Producer;
use Kafka\ProducerConfig;
use yii\base\Component;

class LKafkaProducerQueue extends Component
{
    public $requireAck = 0;
    public $isAsyn = true;
    public $produceInterval = 5;
    public $metadata;
    public static $defaultMetadata = array(
        "brokerVersion" =>  "1.0.0",
        "requestTimeoutMs"  =>  "6000",
        "refreshIntervalMs" =>  "60000",
        "maxAgeMs"          =>  "10000",
    );
    public $timeout = 3000;
    private $clientId;
    public $messageMaxBytes = 10240;//10kb
    public $config;
    

    public function setClientId()
    {
        if ( !$this->clientId ) {
            $this->clientId = $_SERVER['SERVER_ADDR'] .":" .$_SERVER['SERVER_PORT'] .":php-api";
        }
    }

    public function getClientId()
    {
        if (!$this->clientId) {
            $this->setClientId();
        }

        return $this->clientId;
    }


    public function initConfig( $force = false )
    {
        if (!$this->config || !$this->config instanceof ProducerConfig || $force) {
            $config = ProducerConfig::getInstance();
            if (isset($this->metadata["brokerList"])) {
                $config->setMetadataBrokerList($this->metadata["brokerList"]);
            } else {
                $config->setMetadataBrokerList("192.168.10.111:9092");
            }
            if (isset($this->metadata['brokerVersion'])) {
                $config->setBrokerVersion($this->metadata['brokerVersion']);
            } else {
                $config->setBrokerVersion(self::$defaultMetadata['brokerVersion']);
            }
            if (isset($this->metadata['requestTimeoutMs'])) {
                $config->setBrokerVersion($this->metadata['requestTimeoutMs']);
            } else {
                $config->setBrokerVersion(self::$defaultMetadata['requestTimeoutMs']);
            }
            if (isset($this->metadata['refreshIntervalMs'])) {
                $config->setBrokerVersion($this->metadata['refreshIntervalMs']);
            } else {
                $config->setBrokerVersion(self::$defaultMetadata['brokerVersion']);
            }
            if (isset($this->metadata['maxAgeMs'])) {
                $config->setBrokerVersion($this->metadata['maxAgeMs']);
            } else {
                $config->setBrokerVersion(self::$defaultMetadata['maxAgeMs']);
            }
            $config->setRequiredAck($this->requireAck);
            $config->setIsAsyn($this->isAsyn);
            $config->setProduceInterval($this->produceInterval);
            $config->setTimeout($this->timeout);
            $config->setClientId($this->getClientId());
            $config->setMessageMaxBytes($this->messageMaxBytes);
            $this->config = $config;
        }
    }

    public function init()
    {
        parent::init();
        if (!$this->config || !$this->config instanceof ProducerConfig) {
            $this->initConfig();
        }
    }

    public function send( $message )
    {
        if (!$this->config || !$this->config instanceof ProducerConfig) {
            $this->initConfig();
        }

        $producer = new Producer();

        return $producer->send( $message );
    }
}
```

上面kafka使用基本完整了。

这里补充下异常/错误的处理。

\common\components\LErrorHandler.php 内容
```php
<?php
namespace common\components;

use common\misc\LError;
use Yii;
use yii\web\Application;
use yii\web\ErrorHandler;
use yii\web\HttpException;

class LErrorHandler extends ErrorHandler
{
    public function handleException( $exception )
    {
        $data = $this->formatException( $exception );
        /** @var $app Application */
        $app = Yii::$app;
        /** @var $controller LController */
        $controller = $app->controller;
        if ( !$controller instanceof LController ) {
            $controller = $app->createController('');
            $controller = $controller[0];
        }

        $this->logException( $exception );
        $controller->ajaxReturn( isset($data['errorCode']) ? $data['errorCode'] : $data['code'],
            YII_DEBUG ? $data['message'] : array(),
            YII_DEBUG ? $data : array()
        );
    }

    public function handleError( $code, $message, $file, $line )
    {
        /** @var $app Application */
        $app = Yii::$app;
        /** @var $controller LController */
        $controller = $app->controller;
        if ( !$controller instanceof LController ) {
            $controller = $app->createController('/site');
            $controller = $controller[0];
        }

        $exception =  new \ErrorException($message, $code, 1, $file, $line);
        $this->logException( $exception );

        $data = ["msg" => "file:".$file.",line:".$line];
        $controller->ajaxReturn( LError::INTERNAL_ERROR,
            YII_DEBUG ? $message : array(),
            YII_DEBUG ? $data : array()
        );
    }

    protected function formatException( $exception )
    {
        $fileName = $exception->getFile();
        $errorLine = $exception->getLine();

        $trace = $exception->getTrace();

        foreach ($trace as $i => $t)
        {
            if (!isset($t['file'])) {
                $trace[$i]['file'] = 'unknown';
            }

            if (!isset($t['line'])) {
                $trace[$i]['line'] = 0;
            }

            if (!isset($t['function'])) {
                $trace[$i]['function'] = 'unknown';
            }

            unset($trace[$i]['object']);
        }

        return array(
            'code' => ($exception instanceof HttpException) ? $exception->statusCode : 500,
            'type' => get_class($exception),
            'errorCode' => $exception->getCode(),
            'message' => $exception->getMessage(),
            'file' => $fileName,
            'line' => $errorLine,
            'trace' => $exception->getTraceAsString(),
            'traces' => $trace,
        );
    }


    public function renderException( $exception )
    {
        $this->handleException( $exception );
    }

    public function handleFatalError()
    {
        $error = error_get_last();
        if ( LException::isFatalError($error) ) {
            $exception = new \ErrorException( $error['message'], 500, $error['type'], $error['file'], $error['line'] );
            $this->exception = $exception;
            $this->logException( $exception );

            if ($this->discardExistingOutput) {
                $this->clearOutput();
            }
            // need to explicitly flush logs because exit() next will terminate the app immediately
            Yii::getLogger()->flush(true);
            $this->handleException( $exception );
        }
    }
}
```


<br/><br/><br/><br/><br/>
#### 参考资料

<https://blog.csdn.net/weiwenjuan0923/article/details/76152744>

<https://www.cnblogs.com/Life-Record/p/4964344.html>

<http://www.w3school.com.cn/php/php_exception.asp>

<http://www.runoob.com/php/php-error.html>

<http://www.runoob.com/php/php7-new-features.html>
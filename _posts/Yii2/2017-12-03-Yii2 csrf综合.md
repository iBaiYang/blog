---
layout: post
categories: Yii2
title: Yii2 csrf综合
meta: Yii2 csrf综合
---
* content
{:toc}

### 正文

CSRF（Cross-site request forgery）跨站请求伪造，也被称为“One Click Attack”或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用。

XSS（Cross Site Scripting）跨站脚本攻击，恶意攻击者往Web页面里插入恶意Script代码，当用户浏览该页之时，嵌入其中Web里面的Script代码会被执行，从而达到恶意攻击用户的目的。

XSS和MySQL注入攻击类似，CSRF是诱导用户点击或提交网址实现攻击目的（[可以看这里理解](https://zhuanlan.zhihu.com/p/22521378)）。

我们项目中经常会用到ajax交互技术，但_csrf验证怎么办呢？我们需要在这次提交中同时提交csrf的信息，但是怎么获取呢？加入这个表单项：

```
<input type="hidden" name="_csrf" value="<?= Yii::$app->request->csrfToken ?>">
```

接下来，取值同时传过去就ok了。

csrf是为了防止跨站请求伪造攻击，在配置文件backend/config/main.php中可以设置名字：

```
'components' => [
    'request' => [
        'csrfParam' => '_csrf-backend',
    ],
],        
```

如果使用Yii2原生的表单工具：

```
<div class="col-lg-5">
    <?php $form = ActiveForm::begin(['id' => 'login-form']); ?>

        <?= $form->field($model, 'username')->textInput(['autofocus' => true]) ?>

        <?= $form->field($model, 'password')->passwordInput() ?>

        <?= $form->field($model, 'rememberMe')->checkbox() ?>

        <div class="form-group">
            <?= Html::submitButton('登录', ['class' => 'btn btn-primary', 'name' => 'login-button']) ?>
        </div>

    <?php ActiveForm::end(); ?>
</div>
```

生成的html代码：

```
<div class="col-lg-5">
    <form id="login-form" action="/site/login.html" method="post" role="form">
        <input type="hidden" name="_csrf-backend" value="v5G4eIFl_Lel0yPkbWPqDw1l7jJWYknp9AXY6sF_xKeLwOIgyVXL1dyBELteFKtVTwqoAw8hFr-VSo2c9x2vyg==">
        <div class="form-group field-adminloginform-username required has-error">
            <label class="control-label" for="adminloginform-username">用户名</label>
            <input type="text" id="adminloginform-username" class="form-control" name="AdminLoginForm[username]" autofocus="" aria-required="true" aria-invalid="true">
            <p class="help-block help-block-error">用户名不能为空。</p>
        </div>
        <div class="form-group field-adminloginform-password required">
            <label class="control-label" for="adminloginform-password">密码</label>
            <input type="password" id="adminloginform-password" class="form-control" name="AdminLoginForm[password]" aria-required="true">
            <p class="help-block help-block-error"></p>
        </div>
        <div class="form-group field-adminloginform-rememberme">
            <div class="checkbox">
                <label for="adminloginform-rememberme">
                    <input type="hidden" name="AdminLoginForm[rememberMe]" value="0">
                    <input type="checkbox" id="adminloginform-rememberme" name="AdminLoginForm[rememberMe]" value="1" checked="">
                    记住密码
                </label>
                <p class="help-block help-block-error"></p>
            </div>
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-primary" name="login-button">登录</button>                
        </div>
    </form>        
</div>
```

如果用ajax请求，csrf怎么赋值呢：

```
方法一：
<input type="hidden" name="_csrf" value="<?= Yii::$app->request->csrfToken ?>">

方法二：
// head头中有csrf-token
<meta name="csrf-token" content="v5G4eIFl_Lel0yPkbWPqDw1l7jJWYknp9AXY6sF_xKeLwOIgyVXL1dyBELteFKtVTwqoAw8hFr-VSo2c9x2vyg==">
var csrfToken = $('meta[name="csrf-token"]').attr("content");
$.ajax({
  type: 'POST',
  url: url,
  data: {_csrf:csrfToken},
  success: success,
  dataType: dataType
});
```

在特定控制器中不想用csrf，可以关闭：

```
方法一：
public $enableCsrfValidation = false;

方法二：
public function init() {
    $this->enableCsrfValidation = false;
}
```

看一下Yii2中csrf原理：

存储位置

```
    protected function createCsrfCookie($token)
    {
        $options = $this->csrfCookie;
        $options['name'] = $this->csrfParam;
        $options['value'] = $token;
        return new Cookie($options);
    }
```

校验方法

```
    public function validateCsrfToken($token = null)
    {
        $method = $this->getMethod();
        // only validate CSRF token on non-"safe" methods http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.1.1
        if (!$this->enableCsrfValidation || in_array($method, ['GET', 'HEAD', 'OPTIONS'], true)) {
            return true;
        }

        $trueToken = $this->loadCsrfToken();

        if ($token !== null) {
            return $this->validateCsrfTokenInternal($token, $trueToken);
        } else {
            return $this->validateCsrfTokenInternal($this->getBodyParam($this->csrfParam), $trueToken)
                || $this->validateCsrfTokenInternal($this->getCsrfTokenFromHeader(), $trueToken);
        }
    }
```

<br/><br/><br/><br/><br/>
### 参考资料 

<https://www.cnblogs.com/bjfy/p/5939317.html>

<https://zhuanlan.zhihu.com/p/28870147>

<https://zhuanlan.zhihu.com/p/22521378>

<https://www.cnblogs.com/cnn2017/p/6800679.html>

<https://www.yiichina.com/tutorial/449>

<https://blog.csdn.net/u012979009/article/details/51790925>

<https://www.yiichina.com/code/927>
---
layout: post
categories: IT技术
title: 微信小程序开发记录
meta: 微信小程序开发记录
---
* content
{:toc}

### 正文

微信小程序开发，如果有后端服务，就牵扯到session认证、用户信息微信跨服务注册（小程序、公众号）。

用户信息微信跨服务注册，就是微信中只有一个用户标识，通过这一个标识，不论是在小程序、还是公众号，都知道你是你，而不会产生两个账号的问题，
这个标识就是openid，需要保存在后端数据库。

OpenID和unionid还是需要讨论确认一下。

不过小程序并不能直接获取到openid，需要调用 wx.login() 获取 临时登录凭证code ，并回传到开发者服务器。
开发者服务器再调用 code2Session 接口，换取 用户唯一标识 OpenID 和 会话密钥 session_key。

看一下实际过程：
```
//app.js
App({
    onLaunch: function () {
        // 登录
        wx.login({
            success: res => {
                console.log(res.code);
                // 发送 res.code 到后台换取 openId, sessionKey, unionId
                wx.request({
                    url: 'http://localhost/mi/getopenID.php',
                    data:{code: res.code},
                    success:(res)=>{
                        console.log(res.data.openid);
                        this.globalData.openID = res.data.openid;
                    }
                })
            }
        })
    }
})
```

后端处理：
```
// 声明CODE，获取小程序传过来的CODE
$code = $_GET["code"];

// 配置appid 此处填写你的appid
$appid = "";

//配置appscret 此处填写你的appsecret
$secret = "";

//api接口
$api = "https://api.weixin.qq.com/sns/jscode2session?appid={$appid}&secret={$secret}&js_code={$code}&grant_type=authorization_code";

//获取GET请求
function httpGet($url){
    $curl = curl_init();
    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 2);
    curl_setopt($curl, CURLOPT_TIMEOUT, 500);
    curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, 2);
    curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, 2);
    curl_setopt($curl, CURLOPT_URL, $url);
    
    $res = curl_exec($curl);
    curl_close($curl);
    
    return $res;
}

//发送
$str = httpGet($api);

// 然后就可以看到返回的openid了，在一个json字符串中
echo $str;
```



wx.getSetting(Object object)

获取用户的当前设置。返回值中只会出现小程序已经向用户请求过的权限。

```
// 获取用户信息
wx.getSetting({
  success: res => {
    if (res.authSetting['scope.userInfo']) {
      // 已经授权，可以直接调用 getUserInfo 获取头像昵称，不会弹框
      wx.getUserInfo({
        success: res => {
          // 可以将 res 发送给后台解码出 unionId
          this.globalData.userInfo = res.userInfo

          // 由于 getUserInfo 是网络请求，可能会在 Page.onLoad 之后才返回
          // 所以此处加入 callback 以防止这种情况
          if (this.userInfoReadyCallback) {
            this.userInfoReadyCallback(res)
          }
        }
      })
    }
  }
})
```

微信小程序不支持session，除了变相使用cookie实现session认证外，我们还可以用JWT实现前后端认证。

#### 示例demo

```
<!--index.wxml-->
<view class="container">
  <view class="userinfo">
    <button wx:if="{{!hasUserInfo && canIUse}}" open-type="getUserInfo" bindgetuserinfo="getUserInfo"> 获取头像昵称 </button>
    <block wx:else>
      <image bindtap="bindViewTap" class="userinfo-avatar" src="{{userInfo.avatarUrl}}" mode="cover"></image>
      <text class="userinfo-nickname">{{userInfo.nickName}}</text>
    </block>
  </view>
  <view class="usermotto">
    <text class="user-motto">{{motto}}</text>
  </view>
</view>
```

```
// index.js
//获取应用实例
const app = getApp()

Page({
  data: {
    motto: 'Hello World',
    userInfo: {},
    hasUserInfo: false,
    canIUse: wx.canIUse('button.open-type.getUserInfo')
  },
  //事件处理函数
  bindViewTap: function() {
    wx.navigateTo({
      url: '../logs/logs'
    })
  },
  onLoad: function () {
    if (app.globalData.userInfo) {
      this.setData({
        userInfo: app.globalData.userInfo,
        hasUserInfo: true
      })
    } else if (this.data.canIUse){
      // 由于 getUserInfo 是网络请求，可能会在 Page.onLoad 之后才返回
      // 所以此处加入 callback 以防止这种情况
      app.userInfoReadyCallback = res => {
        this.setData({
          userInfo: res.userInfo,
          hasUserInfo: true
        })
      }
    } else {
      // 在没有 open-type=getUserInfo 版本的兼容处理
      wx.getUserInfo({
        success: res => {
          app.globalData.userInfo = res.userInfo
          this.setData({
            userInfo: res.userInfo,
            hasUserInfo: true
          })
        }
      })
    }
  },
  getUserInfo: function(e) {
    console.log(e)
    app.globalData.userInfo = e.detail.userInfo
    this.setData({
      userInfo: e.detail.userInfo,
      hasUserInfo: true
    })
  }
})
```

```
<!--logs.wxml-->
<view class="container log-list">
  <block wx:for="{{logs}}" wx:for-item="log">
    <text class="log-item">{{index + 1}}. {{log}}</text>
  </block>
</view>
```

```
// logs.js
const util = require('../../utils/util.js')

Page({
  data: {
    logs: []
  },
  onLoad: function () {
    this.setData({
      logs: (wx.getStorageSync('logs') || []).map(log => {
        return util.formatTime(new Date(log))
      })
    })
  }
})
```

```
// utils/util.js
const formatTime = date => {
  const year = date.getFullYear()
  const month = date.getMonth() + 1
  const day = date.getDate()
  const hour = date.getHours()
  const minute = date.getMinutes()
  const second = date.getSeconds()

  return [year, month, day].map(formatNumber).join('/') + ' ' + [hour, minute, second].map(formatNumber).join(':')
}

const formatNumber = n => {
  n = n.toString()
  return n[1] ? n : '0' + n
}

module.exports = {
  formatTime: formatTime
}
```

<br/><br/><br/><br/><br/>
### 参考资料

wx.login 获取 用户的openid <https://www.jianshu.com/p/1b35561dc322>

auth.code2Session <https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html#%E8%AF%B7%E6%B1%82%E5%9C%B0%E5%9D%80>

小程序登录 <https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html>

UnionID 机制说明 <https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/union-id.html>

微信的OpenID究竟是什么 <https://zhuanlan.zhihu.com/p/111355529>

wx.getSetting(Object object)

用户信息 wx.getUserInfo(Object object) <https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserInfo.html>

boolean wx.canIUse(string schema) <https://developers.weixin.qq.com/miniprogram/dev/api/base/wx.canIUse.html>

微信小程序登录对接Django后端实现JWT方式验证登录 <https://blog.csdn.net/weixin_33894640/article/details/93283473>


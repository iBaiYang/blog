---
layout: post
categories: IT技术
title: LBS经纬度编码搜索实现
meta: LBS经纬度编码搜索实现
---
* content
{:toc}

## 正文

### Geohash算法 PHP实现

geohash.class.php
```php
<?php
/**
* Encode and decode geohashes
*/
class Geohash 
{
    private $coding = "0123456789bcdefghjkmnpqrstuvwxyz";
    private $codingMap = array();
 
    public function Geohash() {
        for ($i = 0; $i < 32; $i++) {
            $this->codingMap[substr($this->coding, $i, 1)] = str_pad(decbin($i), 5, "0", STR_PAD_LEFT);
        }
    }
 
    public function decode($hash) {
        $binary = "";
        $hl = strlen($hash);
        for ($i = 0; $i < $hl; $i++) {
            $binary .= $this->codingMap[substr($hash, $i, 1)];
        }
 
        $bl = strlen($binary);
        $blat = "";
        $blong = "";
        for ($i = 0; $i < $bl; $i++) {
            if ($i%2) {
                $blat = $blat.substr($binary, $i, 1);
            } else {
                $blong = $blong.substr($binary, $i, 1);
            }
        }
 
        $lat = $this->binDecode($blat, -90, 90);
        $long = $this->binDecode($blong, -180, 180);
 
        $latErr = $this->calcError(strlen($blat), -90, 90);
        $longErr = $this->calcError(strlen($blong), -180, 180);
 
        $latPlaces = max(1, -round(log10($latErr))) - 1;
        $longPlaces = max(1, -round(log10($longErr))) - 1;
 
        $lat = round($lat, $latPlaces);
        $long = round($long, $longPlaces);
 
        return array($lat,$long);
    }
 
    public function encode($lat,$long) {
        $plat = $this->precision($lat);
        $latbits = 1;
        $err = 45;
        while ($err > $plat) {
            $latbits++;
            $err /= 2;
        }
 
        $plong = $this->precision($long);
        $longbits = 1;
        $err = 90;
        while ($err > $plong) {
            $longbits++;
            $err /= 2;
        }
        $bits = max($latbits,$longbits);
        $longbits = $bits;
        $latbits = $bits;
        $addlong = 1;
        while (($longbits+$latbits) % 5 != 0) {
            $longbits += $addlong;
            $latbits += !$addlong;
            $addlong = !$addlong;
        }
        $blat = $this->binEncode($lat, -90, 90, $latbits);
        $blong = $this->binEncode($long, -180, 180, $longbits);
        $binary = "";
        $uselong = 1;
        while (strlen($blat)+strlen($blong)) {
            if ($uselong) {
                $binary = $binary.substr($blong, 0, 1);
                $blong = substr($blong, 1);
            } else {
                $binary = $binary.substr($blat, 0, 1);
                $blat = substr($blat, 1);
            }
            $uselong = !$uselong;
        }
        $hash = "";
        for ($i = 0; $i < strlen($binary); $i += 5) {
            $n = bindec(substr($binary, $i, 5));
            $hash = $hash . $this->coding[$n];
        }
        return $hash;
    }
 
    private function calcError($bits, $min, $max) {
        $err = ($max - $min) / 2;
        while ($bits--) {
            $err /= 2;
	    }
        return $err;
    }
 
    private function precision($number) {
        $precision = 0;
        $pt = strpos($number,'.');
        if ($pt!== false) {
            $precision = -(strlen($number) - $pt - 1);
        }
        return pow(10, $precision) / 2;
    }
 
    private function binEncode($number, $min, $max, $bitcount) {
        if ($bitcount == 0) {
            return "";
	    }
        $mid = ($min + $max) / 2;
        if ($number > $mid) {
            return "1" . $this->binEncode($number, $mid, $max, $bitcount - 1);
        } else {
            return "0" . $this->binEncode($number, $min, $mid, $bitcount - 1);
	    }
    }
 
    private function binDecode($binary, $min, $max) {
        $mid = ($min + $max) / 2;
 
        if (strlen($binary) == 0) {
            return $mid;
	    } 
        $bit = substr($binary, 0, 1);
        $binary = substr($binary, 1);
 
        if ($bit == 1) {
            return $this->binDecode($binary, $mid, $max);
        } else {
            return $this->binDecode($binary, $min, $mid);
        }
    }
}
```

使用：
```php
<?php
require_once('geohash.class.php');

$longitude = 113.93041;  // 经度
$latitude = 22.53332;  // 维度

$geohash = new Geohash;
$geohash_val = $geohash->encode($latitude, $longitude);  // 输出 ws100w1d4gr

//附近，参数n代表Geohash，精确的位数，也就是大概距离；n=6时候，大概为附近1千米
$n = 6;
$like_geohash = substr($geohash_val, 0, $n);
```

### 函数原型

```
/**
 * 指数表达式
 * Exponential expression
 * @link https://php.net/manual/en/function.pow.php
 * @param int|float $num <p>
 * The base to use
 * </p>
 * @param int|float $exponent <p>
 * The exponent
 * </p>
 * @return int|float base raised to the power of exp.
 * If the result can be represented as integer it will be returned as type
 * integer, else it will be returned as type float.
 * If the power cannot be computed false will be returned instead.
 */
#[Pure]
function pow ($num, $exponent) {}

/**
 * Binary to decimal
 * @link https://php.net/manual/en/function.bindec.php
 * @param string $binary_string <p>
 * The binary string to convert
 * </p>
 * @return int|float The decimal value of binary_string
 */
#[Pure]
function bindec ($binary_string) {}

/**
 * Returns the rounded value of val to specified precision (number of digits after the decimal point).
 * precision can also be negative or zero (default).
 * Note: PHP doesn't handle strings like "12,300.2" correctly by default. See converting from strings.
 * @link https://php.net/manual/en/function.round.php
 * @param float $num <p>
 * The value to round
 * </p>
 * @param int $precision [optional] <p>
 * The optional number of decimal digits to round to.
 * </p>
 * @param int $mode [optional] <p>
 * One of PHP_ROUND_HALF_UP,
 * PHP_ROUND_HALF_DOWN,
 * PHP_ROUND_HALF_EVEN, or
 * PHP_ROUND_HALF_ODD.
 * </p>
 * @return float The rounded value
 */
#[Pure]
function round ($num, $precision = 0, $mode = PHP_ROUND_HALF_UP) {}

/**
 * Natural logarithm
 * @link https://php.net/manual/en/function.log.php
 * @param float $num <p>
 * The value to calculate the logarithm for
 * </p>
 * @param float $base [optional] <p>
 * The optional logarithmic base to use
 * (defaults to 'e' and so to the natural logarithm).
 * </p>
 * @return float The logarithm of arg to
 * base, if given, or the
 * natural logarithm.
 */
#[Pure]
function log ($num, $base = null) {}

/**
 * Base-10 logarithm
 * @link https://php.net/manual/en/function.log10.php
 * @param float $num <p>
 * The argument to process
 * </p>
 * @return float The base-10 logarithm of arg
 */
#[Pure]
function log10 ($num) {}
```

<br/><br/><br/><br/><br/>
## 参考资料

geohash实现距离排序算法php <https://blog.csdn.net/littlexiaoshuishui/article/details/88950064>

LBS：附近搜索（geohash算法：经纬度编码搜索） Django <http://www.360doc.com/content/14/0714/20/16044571_394404568.shtml>


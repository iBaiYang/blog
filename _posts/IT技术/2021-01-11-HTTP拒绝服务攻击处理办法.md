---
layout: post
categories: IT技术
title: HTTP拒绝服务攻击处理办法
meta: HTTP拒绝服务攻击处理办法
---
* content
{:toc}

### 正文

#### 概述

缓慢的HTTP拒绝服务攻击是一种专门针对于Web的应用层拒绝服务攻击，攻击者操纵网络上的肉鸡，对目标Web服务器进行海量HTTP请求攻击，
直到服务器带宽被打满，造成了拒绝服务。 慢速HTTP拒绝服务攻击经过不断的演变和发展，
主要有三种攻击类型，分别是Slow headers、Slow body、Slow read。

**Slow headers**：Web应用在处理HTTP请求之前都要先接收完所有的HTTP头部，因为HTTP头部中包含了一些Web应用可能用到的重要的信息。
攻击者利用这点，发起一个HTTP请求，一直不停的发送HTTP头部，消耗服务器的连接和内存资源。抓包数据可见，攻击客户端与服务器建立TCP连接后，
每10秒才向服务器发送一个HTTP头部，而Web服务器在没接收到2个连续的\r\n时，会认为客户端没有发送完头部，而持续的等等客户端发送数据。
如果恶意攻击者客户端持续建立这样的连接，那么服务器上可用的连接将一点一点被占满，从而导致拒绝服务。

**Slow body**：攻击者发送一个HTTP POST请求，该请求的Content-Length头部值很大，使得Web服务器或代理认为客户端要发送很大的数据。
服务器会保持连接准备接收数据，但攻击客户端每次只发送很少量的数据，使该连接一直保持存活，消耗服务器的连接和内存资源。

**Slow read**：客户端与服务器建立连接并发送了一个HTTP请求，客户端发送完整的请求给服务器端，
然后一直保持这个连接，以很低的速度读取Response，比如很长一段时间客户端不读取任何数据，通过发送Zero Window到服务器，
让服务器误以为客户端很忙，直到连接快超时前才读取一个字节，以消耗服务器的连接和内存资源。

#### server防御配置

##### Nginx

1、通过调整$request_method，配置服务器接受http包的操作限制；

2、在保证业务不受影响的前提下，调整 client_max_body_size, client_body_buffer_size, client_header_buffer_size,
large_client_header_buffersclient_body_timeout, client_header_timeout 的值，必要时可以适当的增加；

如：
```
client_max_body_size 1M;
client_body_buffer_size 16k;
client_header_buffer_size 1k;
large_client_header_buffers 4 8k;
client_body_timeout 5s;
client_header_timeout 5s;
client_body_in_single_buffer on;
#client_body_in_file_only clean;
#client_body_temp_path 1 2;
```

3、对于会话或者相同的ip地址，可以使用HttpLimitReqModule and HttpLimitZoneModule参数去限制请求量或者并发连接数；

4、根据CPU和负载的大小，来配置worker_processes 和 worker_connections的值，公式是：max_clients = worker_processes * worker_connections。

##### Apache

建议使用mod_reqtimeout和mod_qos两个模块相互配合来防护。

1、mod_reqtimeout用于控制每个连接上请求发送的速率。

配置例如：
```
#请求头部分，设置超时时间初始为10秒，并在收到客户端发送的数据后，每接收到500字节数据就将超时时间延长1秒，但最长不超过40秒。可以防护slowloris型的慢速攻击。
RequestReadTimeout header=10-40,minrate=500
#请求正文部分，设置超时时间初始为10秒，并在收到客户端发送的数据后，每接收到500字节数据就将超时时间延长1秒，但最长不超过40秒。可以防护slow message body型的慢速攻击。
RequestReadTimeout body=10-40,minrate=500
```

需注意，对于HTTPS站点，需要把初始超时时间上调，比如调整到20秒。

示例：
LoadModule reqtimeout_module modules/mod_reqtimeout.so
```
<IfModule reqtimeout_module>
RequestReadTimeout header=10-40,minrate=500 body=10-40,minrate=500
</IfModule>
```

2、mod_qos用于控制并发连接数。

配置例如：
```
# 当服务器并发连接数超过600时，关闭keepalive
QS_SrvMaxConnClose 600
# 限制每个源IP最大并发连接数为50
QS_SrvMaxConnPerIP 50
```

这两个数值可以根据服务器的性能调整。

更多关于qos_module配置参考：
http://mod-qos.sourceforge.net/dos.html

示例：
LoadModule qos_module modules/mod_qos.so
```
<IfModule qos_module>
QS_SrvMaxConnClose 600
QS_SrvMaxConnPerIP 50
</IfModule>
```

<br/><br/><br/><br/><br/>
### 参考资料

使用slowhttptest进行http慢速攻击渗透测试与nginx防御 <https://www.yuque.com/wangtao-7pwni/ivs01l/dvg2ci>


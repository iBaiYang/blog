---
layout: post
categories: Linux
title: Win10家庭版WSL2安装Centos7.8
meta: Win10家庭版WSL2安装Centos7.8
---
* content
{:toc}

## 正文

### WSL2安装

**步骤 1** - 检查运行 WSL 2 的要求

WSL2对Win10版本的要求：

    对于 x64 系统：版本 1903 或更高版本，采用 内部版本 18362 或更高版本。
    对于 ARM64 系统：版本 2004 或更高版本，采用 内部版本 19041 或更高版本。
    低于 18362 的版本不支持 WSL 2。 使用 Windows Update 助手更新 Windows 版本。

win + R 输入 `winver` 确定。

如果不满足，更新版本。

**步骤 2** - 启用适用于 Linux 的 Windows 子系统

以管理员身份打开 PowerShell 并运行：
> dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart

**步骤 3** - 启用虚拟机功能

以管理员身份打开 PowerShell 并运行：
> dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart

重新启动 计算机，以完成 WSL 安装并更新到 WSL 2。

**步骤 4** - 下载 Linux 内核更新包

PowerShell 输入：`systeminfo` 查看 "System Type" 确认 系统类型。

下载 WSL2 Linux 内核更新包，如 x64 的 [https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi](https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi) 。

运行上一步中下载的更新包。 （双击以运行 - 系统将提示你提供提升的权限，选择“是”以批准此安装。）

**步骤 5** - 将 WSL 2 设置为默认版本

打开 PowerShell，将 WSL 2 设置为默认版本：
```
wsl --set-default-version 2
```

这时WSL2就安装完成，查看帮助：
```
wsl --help
```

**步骤 6** - 安装所选的 Linux 分发

如果想用Ubuntu等Linux，可以在 微软软件商店 下载安装。Centos在这里是收费的，可以选择手动安装。

**上述细节**

```
Windows PowerShell
版权所有 (C) Microsoft Corporation。保留所有权利。

尝试新的跨平台 PowerShell https://aka.ms/pscore6

PS C:\Windows\system32> dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart

部署映像服务和管理工具
版本: 10.0.19041.844

映像版本: 10.0.19043.1165

启用一个或多个功能
[==========================100.0%==========================]
操作成功完成。
PS C:\Windows\system32>
PS C:\Windows\system32>
PS C:\Windows\system32> dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart

部署映像服务和管理工具
版本: 10.0.19041.844

映像版本: 10.0.19043.1165

启用一个或多个功能
[==========================100.0%==========================]
操作成功完成。
PS C:\Windows\system32>
PS C:\Windows\system32>
PS C:\Windows\system32> systeminfo | find "System Type"
PS C:\Windows\system32>
PS C:\Windows\system32> systeminfo | find "系统类型"
FIND: 参数格式不正确
PS C:\Windows\system32> systeminfo

主机名:           BAIYANG-PC
OS 名称:          Microsoft Windows 10 家庭中文版
OS 版本:          10.0.19043 暂缺 Build 19043
OS 制造商:        Microsoft Corporation
OS 配置:          独立工作站
OS 构建类型:      Multiprocessor Free
注册的所有人:     zhuyingu@126.com
注册的组织:
产品 ID:          00342-33297-06537-AAOEM
初始安装日期:     2020/8/19, 21:57:21
系统启动时间:     2021/8/24, 20:46:12
系统制造商:       LENOVO
系统型号:         20FWA020CD
系统类型:         x64-based PC
处理器:           安装了 1 个处理器。
                  [01]: Intel64 Family 6 Model 94 Stepping 3 GenuineIntel ~2300 Mhz
BIOS 版本:        LENOVO R07ET72W (2.12 ), 2016/10/28
Windows 目录:     C:\Windows
系统目录:         C:\Windows\system32
启动设备:         \Device\HarddiskVolume1
系统区域设置:     zh-cn;中文(中国)
输入法区域设置:   zh-cn;中文(中国)
时区:             (UTC+08:00) 北京，重庆，香港特别行政区，乌鲁木齐
物理内存总量:     24,441 MB
可用的物理内存:   19,202 MB
虚拟内存: 最大值: 28,025 MB
虚拟内存: 可用:   22,608 MB
虚拟内存: 使用中: 5,417 MB
页面文件位置:     C:\pagefile.sys
域:               WORKGROUP
登录服务器:       \\BAIYANG-PC
修补程序:         安装了 14 个修补程序。
                  [01]: KB5004331
                  [02]: KB4561600
                  [03]: KB4570334
                  [04]: KB4576754
                  [05]: KB4577266
                  [06]: KB4577586
                  [07]: KB4580325
                  [08]: KB4586864
                  [09]: KB4589212
                  [10]: KB4593175
                  [11]: KB4598481
                  [12]: KB5000736
                  [13]: KB5005033
                  [14]: KB5005260
网卡:             安装了 4 个 NIC。
                  [01]: Intel(R) Ethernet Connection (2) I219-LM
                      连接名:      以太网
                      状态:        媒体连接已中断
                  [02]: Intel(R) Dual Band Wireless-AC 8260
                      连接名:      WLAN
                      启用 DHCP:   是
                      DHCP 服务器: 192.168.123.1
                      IP 地址
                        [01]: 192.168.123.163
                        [02]: fe80::b42d:38e0:7af1:eb6f
                  [03]: VirtualBox Host-Only Ethernet Adapter
                      连接名:      VirtualBox Host-Only Network
                      启用 DHCP:   否
                      IP 地址
                        [01]: 192.168.56.1
                        [02]: fe80::350e:3a2e:501b:4a41
                  [04]: TAP-Windows Adapter V9
                      连接名:      以太网 3
                      状态:        媒体连接已中断
Hyper-V 要求:     虚拟机监视器模式扩展: 是
                  固件中已启用虚拟化: 是
                  二级地址转换: 是
                  数据执行保护可用: 是
PS C:\Windows\system32>
```

```
PS C:\Users\zhuyi> wsl --list --verbose
适用于 Linux 的 Windows 子系统没有已安装的分发版。
可以通过访问 Microsoft Store 来安装分发版:
https://aka.ms/wslstore
PS C:\Users\zhuyi> wsl --set-default-version 2
有关与 WSL 2 的主要区别的信息，请访问 https://aka.ms/wsl2
操作成功完成。
PS C:\Users\zhuyi>
PS C:\Users\zhuyi>
PS C:\Users\zhuyi> wsl --help
版权所有 (c) Microsoft Corporation。保留所有权利。

用法: wsl.exe [参数] [选项...] [命令行]

运行 Linux 二进制文件的参数:

    如果未提供命令行，wsl.exe 将启动默认 shell。

    --exec, -e <命令行>
        在不使用默认 Linux Shell 的情况下执行指定的命令。

    --
        按原样传递其余命令行。

选项:
    --distribution, -d <Distro>
        运行指定的发行版。

    --user, -u <UserName>
        以指定用户身份运行。

用于管理适用于 Linux 的 Windows 子系统的参数:

    --help
        显示用法信息。

    --install [选项]
        安装额外的适用于 Linux 的 Windows 子系统分发。
         要获得有效分发列表，请使用“wsl --list --online”。

        选项:
            --distribution, -d [参数]
                按名称下载并安装分发。

                参数:
                    有效分发名称(不区分大小写)。

                示例:
                    wsl --install -d Ubuntu
                    wsl --install --distribution Debian

    --set-default-version <版本>
        更改新分发的默认安装版本。

      --shutdown
         立即终止所有运行的分发及 WSL 2
        轻型工具虚拟机。

         --status
           显示适用于 Linux 的 Windows 子系统的状态。

    --update [选项]
        如果未指定任何选项，则 WSL 2 内核将更新
        到最新版本。

             选项:
         --rollback
                还原到 WSL 2 内核的先前版本。

用于管理适用于 Linux 的 Windows 子系统中的分发的参数:

    --set-default-version <版本>
         将分发导出到 tar 文件。
        对于标准输出，文件名可以是 –。

    --import <分发> <安装位置> <文件名> [选项]
            将指定的 tar 文件作为新分发导入。
          对于标准输入，文件名可以是 –。

        选项:
            --version <版本>
                指定要用于新分发的版本。

    --list, -l [选项]
        列出分发。

        选项:
            --all
                列出所有分发，包括
        当前正在安装或卸载的分发。

            --running
                仅列出当前正在运行的分发。

            --quiet, -q
                仅显示分发名称。

            --verbose, -v
                显示所有分发的详细信息。

            --online, -o
                显示使用“wsl --install”进行安装的可用分发列表。

    --set-default, -s <分发>
        将分发设置为默认值。

    --set-version <分发> <版本>
        更改指定分发的版本。

    --terminate, -t <分发>
        终止指定的分发。

    --unregister <分发>
        注销分发并删除根文件系统。
PS C:\Users\zhuyi>
```

### 环境配置

为了管理虚拟机包，我们可以使用 LxRunOffline 。

**安装 Chocolatey**

Chocolatey是一个Windows下的包管理器，类似于Linux下的apt-get或yum。

以管理员身份打开 PowerShell 并运行：
```
Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
```

输出：
```
PS C:\Windows\system32>
PS C:\Windows\system32> Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
Forcing web requests to allow TLS v1.2 (Required for requests to Chocolatey.org)
Getting latest version of the Chocolatey package for download.
Not using proxy.
Getting Chocolatey from https://community.chocolatey.org/api/v2/package/chocolatey/0.10.15.
Downloading https://community.chocolatey.org/api/v2/package/chocolatey/0.10.15 to C:\Users\zhuyi\AppData\Local\Temp\chocolatey\chocoInstall\chocolatey.zip
Not using proxy.
Extracting C:\Users\zhuyi\AppData\Local\Temp\chocolatey\chocoInstall\chocolatey.zip to C:\Users\zhuyi\AppData\Local\Temp\chocolatey\chocoInstall
Installing Chocolatey on the local machine
Creating ChocolateyInstall as an environment variable (targeting 'Machine')
  Setting ChocolateyInstall to 'C:\ProgramData\chocolatey'
WARNING: It's very likely you will need to close and reopen your shell
  before you can use choco.
Restricting write permissions to Administrators
We are setting up the Chocolatey package repository.
The packages themselves go to 'C:\ProgramData\chocolatey\lib'
  (i.e. C:\ProgramData\chocolatey\lib\yourPackageName).
A shim file for the command line goes to 'C:\ProgramData\chocolatey\bin'
  and points to an executable in 'C:\ProgramData\chocolatey\lib\yourPackageName'.

Creating Chocolatey folders if they do not already exist.

WARNING: You can safely ignore errors related to missing log files when
  upgrading from a version of Chocolatey less than 0.9.9.
  'Batch file could not be found' is also safe to ignore.
  'The system cannot find the file specified' - also safe.
chocolatey.nupkg file not installed in lib.
 Attempting to locate it from bootstrapper.
PATH environment variable does not have C:\ProgramData\chocolatey\bin in it. Adding...
警告: Not setting tab completion: Profile file does not exist at
'C:\Users\zhuyi\Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1'.
Chocolatey (choco.exe) is now ready.
You can call choco from anywhere, command line or powershell by typing choco.
Run choco /? for a list of functions.
You may need to shut down and restart powershell and/or consoles
 first prior to using choco.
Ensuring Chocolatey commands are on the path
Ensuring chocolatey.nupkg is in the lib folder
PS C:\Windows\system32>
PS C:\Windows\system32>
```

**安装 LxRunOffline**

WSL 管理软件：LxRunOffline，它可以安装任意发行版到任意目录、转移已安装的 WSL 目录、备份 WSL、设置默认用户和修改环境变量等操作。

以管理员身份打开 PowerShell 并运行：
> choco install lxrunoffline -y

输出：
```
PS C:\Windows\system32> choco install lxrunoffline -y
Chocolatey v0.10.15
Installing the following packages:
lxrunoffline
By installing you accept licenses for the packages.
Progress: Downloading lxrunoffline 3.5.0... 100%

lxrunoffline v3.5.0 [Approved]
lxrunoffline package files install completed. Performing other installation steps.
Progress: 100% - Running                                                                                               Microsoft.Dism.Commands.ImageObject
Downloading lxrunoffline
  from 'https://github.com/DDoSolitary/LxRunOffline/releases/download/v3.5.0/LxRunOffline-v3.5.0-msvc.zip'
Progress: 100% - Completed download of C:\Users\zhuyi\AppData\Local\Temp\chocolatey\lxrunoffline\3.5.0\lxrunofflineInstall.zip (2.54 MB).
Download of lxrunofflineInstall.zip (2.54 MB) completed.
Hashes match.
Extracting C:\Users\zhuyi\AppData\Local\Temp\chocolatey\lxrunoffline\3.5.0\lxrunofflineInstall.zip to C:\tools\lxrunoffline...
C:\tools\lxrunoffline
PATH environment variable does not have C:\tools\lxrunoffline in it. Adding...
Environment Vars (like PATH) have changed. Close/reopen your shell to
 see the changes (or in powershell/cmd.exe just type `refreshenv`).
 The install of lxrunoffline was successful.
  Software installed to 'C:\tools\lxrunoffline'

Chocolatey installed 1/1 packages.
 See the log for details (C:\ProgramData\chocolatey\logs\chocolatey.log).
PS C:\Windows\system32>
```

注意这里安装完成之后，需要退出重启 PowerShell 才能使用。

```
PS C:\Users\zhuyi> lxrunoffline --help
[ERROR] The action "--help" is not recognized.

Supported actions are:
    l, list            List all installed distributions.
    gd, get-default    Get the default distribution, which is used by bash.exe.
    sd, set-default    Set the default distribution, which is used by bash.exe.
    i, install         Install a new distribution.
    ui, uninstall      Uninstall a distribution.
    rg, register       Register an existing installation directory.
    ur, unregister     Unregister a distribution but not delete the installation directory.
    m, move            Move a distribution to a new directory.
    d, duplicate       Duplicate an existing distribution in a new directory.
    e, export          Export a distribution's filesystem to a .tar.gz file, which can be imported by the "install" command.
    r, run             Run a command in a distribution.
    di, get-dir        Get the installation directory of a distribution.
    gv, get-version    Get the filesystem version of a distribution.
    ge, get-env        Get the default environment variables of a distribution.
    se, set-env        Set the default environment variables of a distribution.
    ae, add-env        Add to the default environment variables of a distribution.
    re, remove-env     Remove from the default environment variables of a distribution.
    gu, get-uid        Get the UID of the default user of a distribution.
    su, set-uid        Set the UID of the default user of a distribution.
    gk, get-kernelcmd  Get the default kernel command line of a distribution.
    sk, set-kernelcmd  Set the default kernel command line of a distribution.
    gf, get-flags      Get some flags of a distribution. See https://docs.microsoft.com/en-us/previous-versions/windows/desktop/api/wslapi/ne-wslapi-wsl_distribution_flags for details.
    sf, set-flags      Set some flags of a distribution. See https://docs.microsoft.com/en-us/previous-versions/windows/desktop/api/wslapi/ne-wslapi-wsl_distribution_flags for details.
    s, shortcut        Create a shortcut to launch a distribution.
    ec, export-config  Export configuration of a distribution to an XML file.
    ic, import-config  Import configuration of a distribution from an XML file.
    sm, summary        Get general information of a distribution.
    version            Get version information about this LxRunOffline.exe.
PS C:\Users\zhuyi>
```

### Centos7.8安装

我们先到Centos的github地址下载软件包 
[centos-7.8.2003-x86_64-docker.tar.xz](https://github.com/CentOS/sig-cloud-instance-images/blob/CentOS-7.8.2003-x86_64/docker/centos-7.8.2003-x86_64-docker.tar.xz) 。

LxRunOffline 安装格式：
```
LxRunOffline install -n 自定义系统名称 -d 安装目录路径 -f tar.xz安装包路径
```

例如我们这里将centos7.8安装到G盘的centos78文件夹下，并且命名为centos78，以普通用户身份打开 PowerShell 就可以运行：
```
LxRunOffline install -n centos78 -d G:/centos78 -f G:/softBox/centos-7.8.2003-x86_64-docker.tar.xz
```

查看安装的包：
```
PS C:\Users\zhuyi> wsl -l -v
  NAME        STATE           VERSION
* centos78    Stopped         1
PS C:\Users\zhuyi>
```

转换版本为WSL2：
```
PS C:\Users\zhuyi> wsl --set-version centos78 2
正在进行转换，这可能需要几分钟时间...
有关与 WSL 2 的主要区别的信息，请访问 https://aka.ms/wsl2
转换完成。
PS C:\Users\zhuyi>
PS C:\Users\zhuyi>
PS C:\Users\zhuyi> wsl -l -v
  NAME        STATE           VERSION
* centos78    Stopped         2
PS C:\Users\zhuyi>
PS C:\Users\zhuyi> wsl --set-default-version 2
有关与 WSL 2 的主要区别的信息，请访问 https://aka.ms/wsl2
操作成功完成。
PS C:\Users\zhuyi>
```

接下来就可以使用下述两种方式之一尝试启动：
```
LxRunOffline run -n 自定义系统名称
wsl -d 自定义系统名称
```

启动CentOS7.8并查看版本：
```
PS C:\Users\zhuyi> wsl -d centos78
[root@BaiYang-PC zhuyi]#
[root@BaiYang-PC zhuyi]#
[root@BaiYang-PC zhuyi]# pwd
/mnt/c/Users/zhuyi
[root@BaiYang-PC zhuyi]#
[root@BaiYang-PC zhuyi]# cat /etc/redhat-release
CentOS Linux release 7.8.2003 (Core)
[root@BaiYang-PC zhuyi]#
```

停止CentOS7.8：
```
PS C:\Users\zhuyi> wsl -l -v
  NAME        STATE           VERSION
* centos78    Running         2
PS C:\Users\zhuyi>
PS C:\Users\zhuyi> wsl -t centos78
PS C:\Users\zhuyi>
PS C:\Users\zhuyi> wsl -l -v
  NAME        STATE           VERSION
* centos78    Stopped         2
PS C:\Users\zhuyi>
```


<br/><br/><br/><br/><br/>
## 参考资料

适用于 Linux 的 Windows 子系统安装指南 (Windows 10) <https://docs.microsoft.com/zh-cn/windows/wsl/install-win10>

Windows Terminal + WSL2 + CENTOS 配置Windows命令终端 <https://zhuanlan.zhihu.com/p/347461016>

我们如何透过软件包(Chocolatey)优雅地在Windows安装软件? <https://post.smzdm.com/p/akmv9x44/>

Windows下Chocolatey上手教程 <https://www.jianshu.com/p/5325decea0d2>

LxRunOffline 使用教程 - WSL 自定义安装、备份 <https://p3terx.com/archives/manage-wsl-with-lxrunoffline.html>



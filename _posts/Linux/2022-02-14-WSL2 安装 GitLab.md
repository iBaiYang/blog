---
layout: post
categories: Linux
title: WSL2 安装 GitLab
meta: WSL2 安装 GitLab
---
* content
{:toc}

## 正文

win10启用WSL2，安装的centos7.8:
```
[root@BaiYang-PC ~]# cat /etc/redhat-release
CentOS Linux release 7.8.2003 (Core)
```

我们接下来安装GitLab。

检查内存，安装使用GitLab需要至少4GB可用内存(RAM + Swap)! 由于操作系统和其他正在运行的应用也会使用内存，
所以安装GitLab前一定要注意当前服务器至少有4GB的可用内存。少于4GB内存会出现各种诡异的问题，
而且在使用过程中也经常会出现500错误。

查看内存：
```
[root@BaiYang-PC src]# free -m
              total        used        free      shared  buff/cache   available
Mem:          19103         101       17756          10        1245       18705
Swap:          5120           0        5120
[root@BaiYang-PC src]#
```

### rpm方式安装

切换到目录：
> cd /usr/local/src

下载最新版：
```
wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-14.7.2-ce.0.el7.x86_64.rpm --no-check-certificate
```

下载需要些时间，输出：
```
[root@BaiYang-PC src]# wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-14.7.2-ce.0.el7.x86_64.rpm
--2022-02-14 16:05:49--  https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-14.7.2-ce.0.el7.x86_64.rpm
Resolving mirrors.tuna.tsinghua.edu.cn (mirrors.tuna.tsinghua.edu.cn)... 101.6.15.130, 2402:f000:1:400::2
Connecting to mirrors.tuna.tsinghua.edu.cn (mirrors.tuna.tsinghua.edu.cn)|101.6.15.130|:443... connected.
ERROR: cannot verify mirrors.tuna.tsinghua.edu.cn's certificate, issued by ‘/C=US/O=Let's Encrypt/CN=R3’:
  Issued certificate has expired.
To connect to mirrors.tuna.tsinghua.edu.cn insecurely, use `--no-check-certificate'.
[root@BaiYang-PC src]#
[root@BaiYang-PC src]#
[root@BaiYang-PC src]#
[root@BaiYang-PC src]# wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-14.7.2-ce.0.el7.x86_64.rpm --no-check-certificate
--2022-02-14 16:06:44--  https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-14.7.2-ce.0.el7.x86_64.rpm
Resolving mirrors.tuna.tsinghua.edu.cn (mirrors.tuna.tsinghua.edu.cn)... 101.6.15.130, 2402:f000:1:400::2
Connecting to mirrors.tuna.tsinghua.edu.cn (mirrors.tuna.tsinghua.edu.cn)|101.6.15.130|:443... connected.
WARNING: cannot verify mirrors.tuna.tsinghua.edu.cn's certificate, issued by ‘/C=US/O=Let's Encrypt/CN=R3’:
  Issued certificate has expired.
HTTP request sent, awaiting response... 200 OK
Length: 983726054 (938M) [application/x-redhat-package-manager]
Saving to: ‘gitlab-ce-14.7.2-ce.0.el7.x86_64.rpm’

100%[=============================================================================>] 983,726,054  903KB/s   in 26m 25s

2022-02-14 16:33:11 (606 KB/s) - ‘gitlab-ce-14.7.2-ce.0.el7.x86_64.rpm’ saved [983726054/983726054]

[root@BaiYang-PC src]#
[root@BaiYang-PC src]#
[root@BaiYang-PC src]# ls -l
total 972864
-rw-r--r--  1 root root     57721 Dec 23 16:16 composer-setup.php
-rw-r--r--  1 root root 983726054 Feb  9 04:17 gitlab-ce-14.7.2-ce.0.el7.x86_64.rpm
-rw-r--r--  1 root root      7076 Nov  4 18:25 mysql80-community-release-el7-4.noarch.rpm
-rw-r--r--  1 root root      6140 Nov 12  2015 mysql-community-release-el7-5.noarch.rpm
drwxr-xr-x 18 root root      4096 Dec 14 15:18 protobuf-3.11.2
-rw-r--r--  1 root root   9533148 Dec 14  2019 protobuf-all-3.11.2.zip
drwxr-xr-x 15 root root      4096 Dec 24 14:14 swoole-src-4.8.4
-rwxrwxrwx  1 root root   2855470 Dec 24 13:54 swoole-src-4.8.4.zip
[root@BaiYang-PC src]#
```

安装：
```
rpm -i gitlab-ce-14.7.2-ce.0.el7.x86_64.rpm --force --nodeps
```

输出：
```
[root@BaiYang-PC src]# rpm -i gitlab-ce-14.7.2-ce.0.el7.x86_64.rpm
warning: gitlab-ce-14.7.2-ce.0.el7.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID f27eab47: NOKEY
error: Failed dependencies:
        openssh-server is needed by gitlab-ce-14.7.2-ce.0.el7.x86_64
[root@BaiYang-PC src]#
[root@BaiYang-PC src]# rpm -i gitlab-ce-14.7.2-ce.0.el7.x86_64.rpm --force --nodeps
warning: gitlab-ce-14.7.2-ce.0.el7.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID f27eab47: NOKEY
It looks like GitLab has not been configured yet; skipping the upgrade script.

       *.                  *.
      ***                 ***
     *****               *****
    .******             *******
    ********            ********
   ,,,,,,,,,***********,,,,,,,,,
  ,,,,,,,,,,,*********,,,,,,,,,,,
  .,,,,,,,,,,,*******,,,,,,,,,,,,
      ,,,,,,,,,*****,,,,,,,,,.
         ,,,,,,,****,,,,,,
            .,,,***,,,,
                ,*,.



     _______ __  __          __
    / ____(_) /_/ /   ____ _/ /_
   / / __/ / __/ /   / __ `/ __ \
  / /_/ / / /_/ /___/ /_/ / /_/ /
  \____/_/\__/_____/\__,_/_.___/


Thank you for installing GitLab!
GitLab was unable to detect a valid hostname for your instance.
Please configure a URL for your GitLab instance by setting `external_url`
configuration in /etc/gitlab/gitlab.rb file.
Then, you can start your GitLab instance by running the following command:
  sudo gitlab-ctl reconfigure

For a comprehensive list of configuration options please see the Omnibus GitLab readme
https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md

Help us improve the installation experience, let us know how we did with a 1 minute survey:
https://gitlab.fra1.qualtrics.com/jfe/form/SV_6kVqZANThUQ1bZb?installation=omnibus&release=14-7

[root@BaiYang-PC src]#
```

修改gitlab配置文件指定服务器ip和自定义端口：
> vi /etc/gitlab/gitlab.rb

把`external_url 'http://gitlab.example.com'` 修改为 `external_url 'http://localhost:8080'` 。

修改配置后的编译初始化：
> gitlab-ctl reconfigure

过程报错了：
```
Running handlers:
There was an error running gitlab-ctl reconfigure:

execute[init q] (package::runit_sysvinit line 28) had an error: Mixlib::ShellOut::ShellCommandFailed: Expected process to exit with [0], but received '1'
---- Begin output of init q ----
STDOUT:
STDERR: Couldn't find an alternative telinit implementation to spawn.
---- End output of init q ----
Ran init q returned 1
```

搜索了一下解决办法，没查到。可能是依赖问题，卸载了吧。
```
[root@BaiYang-PC src]# rpm -qa | grep gitlab
gitlab-ce-14.7.2-ce.0.el7.x86_64
[root@BaiYang-PC src]#
[root@BaiYang-PC src]# rpm -e gitlab
error: package gitlab is not installed
[root@BaiYang-PC src]# rpm -e gitlab-ce
[root@BaiYang-PC src]#
[root@BaiYang-PC src]# rpm -qa | grep gitlab
[root@BaiYang-PC src]#
```

gitlab其他命令：
```
重启：
> gitlab-ctl restart

停止：
> gitlab-ctl stop
```

### yum方式安装

配置yum源：
> vi /etc/yum.repos.d/gitlab-ce.repo

写入：
```
[gitlab-ce]
name=Gitlab CE Repository
baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el$releasever/
gpgcheck=0
enabled=1
```

更新本地yum缓存：
> sudo yum makecache

输出：
```

```

安装GitLab社区版(自动安装最新版)：
> sudo yum install -y gitlab-ce 

或者安装指定版本：
> sudo yum install -y gitlab-ce-x.x.x

输出：
```

```

修改gitlab配置：
> vi /etc/gitlab/gitlab.rb

把`external_url 'http://gitlab.example.com'` 修改为 `external_url 'http://localhost:8080'` 。

修改配置后的编译初始化：
> gitlab-ctl reconfigure

重启gitlab：
> gitlab-ctl restart


### dnf方式安装

DNF 是新一代的rpm软件包管理器。他首先出现在 Fedora 18 这个发行版中。而最近，它取代了yum，正式成为 Fedora 22 的包管理器。

DNF包管理器克服了YUM包管理器的一些瓶颈，提升了包括用户体验，内存占用，依赖分析，运行速度等多方面的内容。
DNF使用 RPM, libsolv 和 hawkey 库进行包管理操作。尽管它没有预装在 CentOS 和 RHEL 7 中，但你可以在使用 YUM 的同时使用 DNF。




<br/><br/><br/><br/><br/>
## 参考资料

centOS7 安装gitlab 转 亲测实用 <https://www.cnblogs.com/934827624-qq-com/p/10964722.html>

清华大学开源软件镜像站 <https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/>

dnf 新一代的RPM软件包管理器 <https://ipcmen.com/dnf>

gitlab安装教程 <https://www.cnblogs.com/breg/p/11720407.html>

Linux Centos7/8安装gitlab及配置防坑指南 <https://blog.csdn.net/weixin_44534057/article/details/116076342>

GitLab的安装及使用教程 <https://www.cnblogs.com/weifeng1463/p/7714492.html>

GitLab的安装及使用教程 <https://www.cnblogs.com/lpfuture/p/8582239.html>

docker下gitlab安装配置使用(完整版) <https://www.jianshu.com/p/080a962c35b6>

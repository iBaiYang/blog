---
layout: post
categories: Linux
title: 服务监控与报警
meta: 服务监控与报警
---
* content
{:toc}

### 正文

我们下面使用Prometheus和Grafana对本机服务器性能进行监控。

监控本机，只需要一个exporter。 node_exporter，用于机器系统数据收集。

下面选择用docker实现Prometheus和Grafana。

#### node_exporter安装

下载镜像包：
> sudo docker pull prom/node-exporter

启动node-exporter：
```
sudo docker run -d -p 9100:9100 \
  -v "/proc:/host/proc:ro" \
  -v "/sys:/host/sys:ro" \
  -v "/:/rootfs:ro" \
  --net="host" \
  prom/node-exporter
```

单行格式：
```
sudo docker run -d -p 9100:9100 -v "/proc:/host/proc:ro" -v "/sys:/host/sys:ro" -v "/:/rootfs:ro" --net="host" prom/node-exporter
```

其中目录映射的：`/proc` 正在运行的内核信息映射，主要输出 进程信息、内存资源信息、磁盘分区信息等等；`/sys` 硬件设备的驱动程序信息。

等待几秒，查看端口是否起来：
> netstat -anpt

访问url：`http://127.0.0.1:9100/metrics` ，可以看到收集到数据，有了它就可以做数据展示了。

![]({{site.baseurl}}/images/20201120/20201120155248.png)

#### Prometheus安装

下载镜像包：
> sudo docker pull prom/prometheus

新建目录prometheus，编辑配置文件prometheus.yml：
> mkdir ~/worksoft/prometheus
> vim ~/worksoft/prometheus/prometheus.yml

写入配置并保存：
```
global:
  scrape_interval:  60s
  evaluation_interval: 60s

scrape_configs:
  - job_name: prometheus
    static_configs:
      - targets: ['localhost:9090']
        labels:
          instance: prometheus

  - job_name: linux
    static_configs:
      - targets: ['192.168.44.171:9100']
        labels:
          instance: localhost
```

注意：这里的192.168.44.171是本机ip地址。如果不知道，可以通过 `ip addr` 或 `ifconfig` 查看。

启动prometheus：
```
sudo docker run  -d \
  -p 9090:9090 \
  -v /home/baiyang/worksoft/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml  \
  prom/prometheus
```

单行格式：
```
sudo docker run -d -p 9090:9090 -v /home/baiyang/worksoft/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus
```

查看容器有没有运行起来：
> sudo docker ps -a

查看端口状态：
> netstat -anpt

访问url：`http://127.0.0.1:9090/graph` 、 `http://127.0.0.1:9090/targets` 查看效果。

![]({{site.baseurl}}/images/20201120/20201120155226.png)

如果状态没有UP起来，等待一会，就会UP了。

#### Grafana安装

下载镜像包：
> sudo docker pull grafana/grafana

新建空文件夹grafana-storage，用来存储数据：
> mkdir ~/worksoft/grafana-storage

设置权限，因为grafana用户会在这个目录写入文件，直接设置777，比较简单：
> chmod 777 -R ~/worksoft/grafana-storage

启动grafana：
```
sudo docker run -d \
  -p 3000:3000 \
  --name=grafana \
  -v /home/baiyang/worksoft/grafana-storage:/var/lib/grafana \
  grafana/grafana
```

单行格式：
```
sudo docker run -d -p 3000:3000 --name=grafana -v /home/baiyang/worksoft/grafana-storage:/var/lib/grafana grafana/grafana
```

访问url：`http://127.0.0.1:3000`， 查看效果，账号和密码都是admin。

![]({{site.baseurl}}/images/20201120/20201120160547.png)

然后添加数据源，添加图标 就可以用了。

#### Prometheus+Grafana监控与报警

[基于docker 搭建Prometheus+Grafana](https://www.cnblogs.com/xiao987334176/p/9930517.html)

<br/><br/><br/><br/><br/>
### 参考资料

Prometheus+Grafana监控与报警 <https://www.cnblogs.com/miaocbin/p/12009974.html>

基于docker 搭建Prometheus+Grafana <https://www.cnblogs.com/xiao987334176/p/9930517.html>

linux下 /proc 和 /sys 详解 <https://blog.csdn.net/z1026544682/article/details/98092139>



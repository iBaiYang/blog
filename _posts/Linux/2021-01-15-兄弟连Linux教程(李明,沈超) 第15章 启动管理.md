---
layout: post
categories: Linux
title: 兄弟连Linux教程(李明,沈超) 第15章 启动管理
meta: 兄弟连Linux教程(李明,沈超) 第15章 启动管理
---
* content
{:toc}

## 正文

### 15.1 CentOS 6.x启动管理

#### 15.1.1 系统运行级别

1、运行级别

```
运行级别    含     义
0    关机
1    单用户模式，可以想象为windows的安全模式，主要用于系统修复
2    不完全的命令行模式，不含NFS服务
3    完全的命令行模式，就是标准字符界面
4    系统保留
5    图形模式
6    重启动
```

2、运行级别命令

```
[root@localhost ~]# runlevel 
#查看运行级别命令

[root@localhost ~]# init 运行级别
#改变运行级别命令
```

3、系统默认运行级别

```
[root@localhost ~]# vim /etc/inittab
id:3:initdefault:
#系统开机后直接进入哪个运行级别
```

#### 15.1.2 系统启动过程

**启动流程图**

![]({{site.baseurl}}/images/20210616/20210616204251.png)

**initramfs内存文件系统**

CentOS 6.x中使用initramfs内存文件系统取代了CentOS 5.x中的initrd RAM Disk。
他们的作用类似，可以通过启动引导程序加载到内存中，然后加载启动过程中所需要的内核模块，
比如USB、SATA、SCSI硬盘的驱动和LVM、RAID文件系统的驱动。

```
mkdir /tmp/initramfs
#建立测试目录
cp /boot/initramfs-2.6.32-279.el6.i686.img /tmp/initramfs/
#复制initramfs文件
cd /tmp/initramfs/
file initramfs-2.6.32-279.el6.i686.img 
# 查看是什么文件
mv initramfs-2.6.32-279.el6.i686.img initramfs-2.6.32-279.el6.i686.img.gz
#修改文件的后缀名为.gz
gunzip initramfs-2.6.32-279.el6.i686.img.gz
#解压缩
file initramfs-2.6.32-279.el6.i686.img 
# 查看文件类型
cpio -ivcdu < initramfs-2.6.32-279.el6.i686.img
#解压缩
```

**调用/etc/init/rcS.conf配置文件**

主要功能是两个：
* 先调用/etc/rc.d/rc.sysinit，然后由/etc/rc.d/rc.sysinit配置文件进行Linux系统初始化。
* 然后再调用/etc/inittab，然后由/etc/inittab配置文件确定系统的默认运行级别。

由/etc/rc.d/rc.sysinit初始化
1. 获得网络环境
2. 挂载设备
3. 开机启动画面Plymouth（取替了过往的 RHGB）
4. 判断是否启用SELinux
5. 显示于开机过程中的欢迎画面
6. 初始化硬件
7. 用户自定义模块的加载
8. 配置内核的参数
9. 设置主机名
10. 同步存储器
11. 设备映射器及相关的初始化
12. 初始化软件磁盘阵列（RAID）
13. 初始化 LVM 的文件系统功能
14. 检验磁盘文件系统（fsck）
15. 设置磁盘配额(quota)
16. 重新以可读写模式挂载系统磁盘
17. 更新quota（非必要）
18. 启动系统虚拟随机数生成器
19. 配置机器（非必要）
20. 清除开机过程当中的临时文件
21. 创建ICE目录
22. 启动交换分区（swap）
23. 将开机信息写入/var/log/dmesg文件中

**调用/etc/rc.d/rc文件**

运行级别参数传入/etc/rc.d/rc这个脚本之后，由这个脚本文件按照不同的运行级别启动`/etc/rc[0-6].d/`目录中的相应的程序
* `/etc/rc3.d/k??`开头的文件（??是数字），会按照数字顺序依次关闭
* `/etc/rc3.d/S??`开头的文件（??是数字），会按照数字顺序依次启动


### 15.2 启动引导程序grub

#### 15.2.1 Grub配置文件

1、grub中分区表示

```
硬盘                分区              Linux中设备文件名    Grub中设备文件名
第一块SCSI硬盘      第一个主分区      /dev/sda1            hd(0,0)
                    第二个主分区      /dev/sda2            hd(0,1)
                    扩展分区          /dev/sda3            hd(0,2)
                    第一个逻辑分区    /dev/sda5            hd(0,4)
第二块SCSI硬盘      第一个主分区      /dev/sdb1            hd(1,0)
                    第二个主分区      /dev/sdb2            hd(1,1)
                    扩展分区          /dev/sdb3            hd(1,2)
                    第一个逻辑        /dev/sdb5            hd(1,4)
```

2、grub配置文件

```
vi /boot/grub/grub.conf 

default=0        # 默认启动第一个系统
timeout=5        # 等待时间，默认是5秒
splashimage=(hd0,0)/grub/splash.xpm.gz
    # 这里是指定grub启动时的背景图像文件的保存位置的
hiddenmenu    # 隐藏菜单
title CentOS (2.6.32-279.el6.i686)
        # title就是标题的意思
    root (hd0,0)
        # 是指启动程序的保存分区
    kernel /vmlinuz-2.6.32-279.el6.i686 ro root=UUID=b9a7a1a8-767f-4a87-8a2b-a535edb362c9 
    rd_NO_LUKS  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_MD crashkernel=auto LANG=zh_CN.UTF-8 
    rd_NO_LVM rd_NO_DM rhgb quiet
        # 定义内核加载时的选项
    initrd /initramfs-2.6.32-279.el6.i686.img
        # 指定了initramfs内存文件系统镜像文件的所在位置
```

#### 15.2.2 Grub加密与字符界面分辨率调整

1、grub加密    

```
[root@localhost ~]# grub-md5-crypt 
#生成加密密码串
```

```
[root@localhost ~]# vi /boot/grub/grub.conf
default=0
timeout=5
password --md5 $1$Y84LB1$8tMY2PibScmuOCc8z8U35/
#password选项放在整体设置处。
splashimage=(hd0,0)/grub/splash.xpm.gz
hiddenmenu
…省略部分内容…
```

2、纯字符界面分辨率调整

```
grep "CONFIG_FRAMEBUFFER_CONSOLE" /boot/config-2.6.32-279.el6.i686 
#查询内核是否支持分辨率修改
```

```
色深    640×480    800×600    1024×768    1280×1024
8位     769    771    773    775
15位    784    787    790    793
16位    785    788    791    794
32位    786    789    792    795
```

```
vi /boot/grub/grub.conf

kernel /vmlinuz-2.6.32-279.el6.i686 ro root=UUID=b9a7a1a8-767f-4a87-8a2b-a535edb362c9 rd_NO_LUKS  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_MD crashkernel=auto LANG=zh_CN.UTF-8 rd_NO_LVM rd_NO_DM rhgb quiet vga=791
```

### 15.3 系统修复模式

1、单用户模式

![]({{site.baseurl}}/images/20210429/20210429114361.png)

单用户模式常见的错误修复

遗忘root密码

修改系统默认运行级别

2、光盘修复模式

![]({{site.baseurl}}/images/20210429/20210429114371.png)

重要系统文件丢失，导致系统无法启动

```
bash-4.1# chroot /mnt/sysimage
#改变主目录
sh-4.1# cd /root
sh-4.1# rpm -qf /etc/inittab
#查询下/etc/inittab文件属于哪个包。
sh-4.1# mkdir /mnt/cdrom
#建立挂载点
sh-4.1# mount /dev/sr0 /mnt/cdrom
#挂载光盘
```

```
sh-4.1#  rpm2cpio   \
 /mnt/cdrom/Packages/initscripts-8.45.3-1.i386.rpm  \
 | cpio -idv ./etc/inittab
#提取inittab文件到当前目录
sh-4.1#  cp etc/inittab /etc/inittab
#复制inittab文件到指定位置
```

3、Linux的安全性

![]({{site.baseurl}}/images/20210429/20210429114381.png)



<br/><br/><br/><br/><br/>
## 参考资料





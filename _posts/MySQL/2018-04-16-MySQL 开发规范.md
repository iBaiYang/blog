---
layout: post
categories: MySQL
title: MySQL开发规范
meta: MySQL开发规范，每个后端开发人员都应该理解。
---
* content
{:toc}

### 基本规范

* 使用INNODB存储引擎。
* 字符集统一使用utf8mb4，使用默认的校对规则。目前线上表约1/3表是utf8字符集。不同字符集字符字段关联索引会失效。后续根据线上慢查询情况，陆续把uft8字符集改为utf8mb4，保持字符集统一。如果将utf8mb4改为utf8会有乱码的风险。
* 所有表必须有注释。
* 不在数据库库存储图片及文件大文件。如有需要存储相关路径。
* 不使用存储过程、自定义函数、触发器、视图、事件。不利于调试和跨平台迁移。
* 不写在严格模式通不过的语句,如：select id,name,count(*) from tb group by id。name没有参与分组也没通过聚合。
* 不存储明文密码。
* 不在线上数据库做压力测试。
* 开发及测试环境不直接连接线上数据库。

### 对象命名规范

* 所有对象遵循“长名”（除非常通用的简写外，尽量避免使用简写）和“表意”（通过名称大致知道该对象所表达的内容），命名中的多个单词通过下划线连接。所有对象命名使用小写。
* 禁止使用MySQL关键字命名。
* 临时库、临时表使用tmp作为前缀，使用_日期作为后缀,如果因为日期后缀导致名称太长，可以去掉日期后缀，在注释里说明。
* 对象名总长度不超过32个字符。

### 表、字段开发规范

* 拆分大字段和访问频率低的字段。不把热点数据和冷数据放在一张表里。
* 分表需符合YYYY[MM][DD][HH]格式
* 无特殊情况不使用TEXT、BLOB数据类型。
* 带小数位的数据存储使用DECIMAL类型，不使用FLOAT类型。
* 所有字段使用NOT NULL约束且需要默认值,TEXT类型不需要默认值。
* 不使用主外键约束。参照完整性通过程序实现。
* 使用VARBINARY存储大小写敏感的变长字符串。
* 父子表的类型、长度、字符集必须保持一致。
* 所有字段必须有注释。
* 字段类型采用够用原则。如tinyint能满足就不使用int类型。varchar(10)能满足则不设计varchar(50)。
* 存储ip最好用int存储而非char(15)。
* 数值类型能满足则不使用varchar等其它类型。
* 日期存储使用datetime,date,TIMESTAMP类型。TIMESTAMP范围比datetime小。
* 不使用ENUM类型，用tinyint代替。
* 对需要对基础表经常关联查询的。可对不更新的数值或长度较小的字符字段，在设计表的时候可以做适当的冗余，如id,userid。避免在查询的时候做太多的关联。
* 表的字段总数不超过50个。

### 索引规范


* 表必须有主键。
* 不使用更新频繁的列作为主键。
* 尽量不选择字符串列作为主键。
* 不使用UUID MD5 HASH这些作为主键。
* 默认使非空的唯一键作为主键。
* 建议选择自增或发号做为主键。
* 避免重复索引，比如索引1(userid,username),索引2(userid)，索引2即为重复索引。
* 不在低基数列上建立索引，如性别。
* 不使用外键约束。参照完整性可通过程序去实现。
* 非唯一索引必须以 idx_字段1_字段2命名，唯一所以必须以uniq_字段1_字段2命名。
* 唯一索引必须不能和主键重复。
* 能使用唯一索引则使用唯一索引，提高查询效率。

### SQL规范


* SQL语句尽可能简单。线上JOIN表的数量不超过3个。超过3个表的SQL需要分解成小的SQL，通过程序实现大的SQL业务逻辑。BI分析系统除外。原则上BI分析系统不允许查询线上数据库（包括从库）。可通过ETL等同步工具同步到数据仓库，分析统计统计业务在数据仓库进行。
* 事务尽可能简单。及时提交事务或回滚事务。
* 降低业务的耦合度，方便以后的数据库切分。
* 避免在数据库中进行复杂的数学和逻辑运算。MySQL为存储层，应实现业务逻辑和存储分离。
* 避免select * 查询，使用什么字段就select 什么字段。降低IO。
* Select 中的or 改为 In ，如：id=1 or id=2 or id=3改为 id in(1,2,3),IN的数量控制在1000以内。
* 注意limit分页。普通的limit的分页，limit越大分页越慢。改写limit分页，如：select id from t order by id limit 10000,10 –> select id from t where id > 10000 order by id limit 10
* union all 能满足业务则不使用union。
* 批量数据更新需打散后分批更新，一次不要更新太多数据。
* 减少与数据库的交互次数。
* SQL语句不可以出现隐式转换，如： select id from 表 where id='1'，数值型不需要引号，字符型、日期型等必须使用引号。
* 应避免not in not like等负向查询。
* like查询应避免 ‘%xx’, ’%xx%’ 。如果这类查询比较多，可考虑第三方软件实现。
* 避免order by rand()查询。
* 避免同一条语句更新、删除多张表数据。
* Inner join 还是 Left join,业务需要才是第一位。Left join 用在需要返回两个共有记录的同时，还需要返回左表不在右表中的记录,Inner join 用在返回两个表共有的记录。不要刻意通过Left join 去实现Inner join的效果,如果通过Left join实现Inner join 的效果需增加更多的条件实现如：where b.xx is not null and c.xx is not null这样会增加代码的复杂度和可读性和误导优化器的判断。
* Delete 、update语句必须有where条件。
* 不使用where 1=1这种没有意义的条件，存在注入风险。
* 如果排序不是必须的，则不使用order by 排序，增加排序的成本。
* 对一个表多次的alter 操作，必须合并为一个语句。

### 流程规范

* SQL审核包括建表语句，update 语句，delete语句，查询语句。
* 审核需提前至少2天，大的项目需提前至少3天通过邮件提供审核脚本。
* 不允许没有经过审核的SQL私自上线。
* 不在业务高峰时执行批量操作和大表查询。


<br/><br/><br/><br/><br/>
### 参考资料：
   技术大神

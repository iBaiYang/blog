---
layout: post
categories: PHP
title: PHP 常见运行模式
meta: 常见运行模式
---
* content
{:toc}

### 正文

SAPI（Server Application Programming Interface）服务器应用程序编程接口。

PHP与其他应用交互的接口就是SAPI，PHP脚本要执行有很多方式，通过Web服务器，或者直接在命令行下，也可以嵌入在其他程序中。

PHP提供了一个和外部通信的接口，常见的有：cgi、fast-cgi、cli、apache模块的DLL、面向Internet服务的isapi。

关于PHP目前比较常见的五大运行模式：

1）CGI（通用网关接口/ Common Gateway Interface）

2）FastCGI（常驻型CGI / Long-Live CGI）

3）CLI（命令行运行 / Command Line Interface）

4）Web模块模式（Apache等Web服务器运行的模式） 

5）ISAPI（Internet Server Application Program Interface）

备注：在PHP5.3以后，PHP不再有ISAPI模式，安装后也不再有php5isapi.dll这个文件。要在IIS6上使用高版本PHP，必须安装FastCGI 扩展，然后使IIS6支持FastCGI。

我们还可以查看php源码研究sapi的处理，在sapi目录下有：
```
apache2handler
cgi
cli
embed
fpm
litespeed
phpdbg
```

PHP的架构图：

![](https://raw.githubusercontent.com/iBaiYang/PictureWareroom/master/20190906/20190906194309.jpg)

#### CGI

CGI 即通用网关接口（Commom Gateway Interface），它把网页和WEB服务器中的执行程序连接起来，把从HTML接收的指令传递给服务器的执行程序，
再把服务器执行程序的结果返还给HTML页。CGI的跨平台性能极佳，几乎可以在任何操作系统上实现。

CGI方式在遇到连接请求先要创建CGI的子进程，激活一个CGI进程，然后处理请求，处理完后结束这个子进程。这就是fork-and-execute模式。
所以用cgi方式的服务器有多少连接请求就会有多少cgi子进程，子进程反复加载是CGI性能低下的主要原因。都会当用户请求数量非常多时，
会大量挤占系统的资源如内存，CPU时间等，造成效能低下。



#### FastCGI

FastCGI（Fast Common Gateway Interface，快速通用网关接口）是一种让交互程序与 Web 服务器通信的协议。
FastCGI 是早期通用网关接口（CGI）的增强版本。FastCGI 致力于减少网页服务器与 CGI 程序之间交互的开销，从而使服务器可以同时处理更多的网页请求。

fast-cgi 是 CGI的升级版本，FastCGI可以看成是一个常驻型的CGI（常驻型CGI / Long-Live CGI），它可以一直执行着，只要激活后，不会每次都要花费时间去fork一次。
PHP使用PHP-FPM（FastCGI Process Manager），全称PHP FastCGI 进程管理器进行管理。

FastCGI的工作原理：
1. Web Server启动时载入FastCGI进程管理器（IIS ISAPI或Apache Module)； 
2. FastCGI进程管理器自身初始化，启动多个CGI解释器进程 (可见多个php-cgi.exe或php-cig)并等待来自Web Server的连接； 
3. 当客户端请求到达Web Server时，FastCGI进程管理器选择并连接到一个CGI解释器。Web server将CGI环境变量和标准输入发送到FastCGI子进程php-cgi； 
4. FastCGI子进程完成处理后将标准输出和错误信息从同一连接返回Web Server。当FastCGI子进程关闭连接时，请求便告处理完成。
FastCGI子进程接着等待并处理来自FastCGI进程管理器（运行在 WebServer中）的下一个连接。在正常的CGI模式中，php-cgi.exe在此便退出了。 

在CGI模式中，你可以想象 CGI通常有多慢。每一个Web请求PHP都必须重新解析php.ini、重新载入全部dll扩展并重初始化全部数据结构。
使用FastCGI，所有这些都只在进程启动时发生一次。一个额外的好处是，持续数据库连接（Persistent database connection）可以工作。 

备注：PHP的FastCGI进程管理器是PHP-FPM（PHP-FastCGI Process Manager）   

【优点】 

1. 从稳定性上看，FastCGI是以独立的进程池来运行CGI，单独一个进程死掉，系统可以很轻易的丢弃，然后重新分配新的进程来运行逻辑； 

2. 从安全性上看，FastCGI支持分布式运算。FastCGI和宿主的Server完全独立，FastCGI怎么down也不会把Server搞垮； 

3. 从性能上看，FastCGI把动态逻辑的处理从Server中分离出来，大负荷的IO处理还是留给宿主Server，这样宿主Server可以一心一意作IO，
对于一个普通的动态网页来说, 逻辑处理可能只有一小部分，大量的是图片等静态。   

【缺点】

用FastCGI模式更适合生产环境的服务器。但对于开发用机器来说就不太合适。因为当调试程序时，由于 FastCGI会认为 PHP进程超时，从而在页面返回 500错误。
对某些服务器的新版本支持不好，对分布式负载均衡没要求的模块化安装是否是更好的选择。目前的FastCGI和Server沟通还不够智能，
一个FastCGI进程如果执行时间过长会被当成是死进程杀掉重起，这样在处理长时间任务的时候很麻烦，这样做也使得FastCGI无法允许联机调试。
因为是多进程，所以比CGI多线程消耗更多的服务器内存，PHP-CGI解释器每进程消耗7至25兆内存，将这个数字乘以50或100就是很大的内存数。 

##### 运行原理

PHP-FPM：实现了fast-cgi协议，直接管理多个php-cgi进程/线程。也就是说，php-fpm是php-cgi的进程管理器。因此它也算是fast-cgi协议的实现。
php的运行原理，就是在服务器启动时，自动载入PHP-FPM进程管理器，从而管理多个PHP-CGI进程来准备响应用户的请求，如下图所示：

![](https://raw.githubusercontent.com/iBaiYang/PictureWareroom/master/20190916/20190916223538.png)

#### CLI

PHP-CLI是PHP Command Line Interface的简称，如同它名字的意思，就是PHP在命令行运行的接口，于在Web服务器上运行的PHP环境（PHP-CGI，ISAPI等）形成区别。 
也就是说，PHP不单可以写前台网页，它还可以用来写后台的程序。 PHP的CLI Shell脚本适用于所有的PHP优势，使创建要么支持脚本或系统甚至与GUI应用程序的服务端，
在Windows和Linux下都是支持PHP-CLI模式的。   

【优点】 

1. 使用多进程，子进程结束以后，内核会负责回收资源； 

2. 使用多进程，子进程异常退出不会导致整个进程Thread退出，父进程还有机会重建流程； 

3. 一个常驻主进程，只负责任务分发，逻辑更清楚。 

我们在Linux下经常使用"php –m"查找PHP安装了那些扩展就是PHP命令行运行模式；有兴趣的同学可以输入"php –h"去深入研究该运行模式。 

#### 模块模式 

模块模式是以mod_php5模块的形式集成，此时mod_php5模块的作用是接收Apache传递过来的PHP文件请求，并处理这些请求，然后将处理后的结果返回给Apache。
如果我们在Apache启动前在其配置文件中配置好了PHP模块（mod_php5）， PHP模块通过注册apache2的ap_hook_post_config挂钩，
在Apache启动的时候启动此模块以接受PHP文件的请求。 

除了这种启动时的加载方式，Apache的模块可以在运行的时候动态装载，这意味着对服务器可以进行功能扩展而不需要重新对源代码进行编译，
甚至根本不需要停止服务器。我们所需要做的仅仅是给服务器发送信号HUP或者AP_SIG_GRACEFUL通知服务器重新载入模块。但是在动态加载之前，
我们需要将模块编译成为动态链接库。此时的动态加载就是加载动态链接库。 Apache中对动态链接库的处理是通过模块mod_so来完成的，
因此mod_so模块不能被动态加载，它只能被静态编译进Apache的核心。这意味着它是随着Apache一起启动的。 

Apache是如何加载模块的呢？我们以前面提到的mod_php5模块为例。首先我们需要在Apache的配置文件httpd.conf中添加一行：
```
LoadModule php5_module modules/mod_php5.so 
```

这里我们使用了LoadModule命令，该命令的第一个参数是模块的名称，名称可以在模块实现的源码中找到。第二个选项是该模块所处的路径。
如果需要在服务器运行时加载模块，可以通过发送信号HUP或者AP_SIG_GRACEFUL给服务器，一旦接受到该信号，Apache将重新装载模块，而不需要重新启动服务器。 

该运行模式是我们以前在windows环境下使用apache服务器经常使用的，而在模块化（DLL）中，PHP是与Web服务器一起启动并运行的。
（它是apache在CGI的基础上进行的一种扩展，加快PHP的运行效率）。


* Apache + mod_php
* lighttp + spawn-fcgi
* nginx + PHP-FPM


##### apache模块的DLL

APACHE2HANDLER

PHP作为Apache模块，Apache服务器在系统启动后，预先生成多个进程副本驻留在内存中，一旦有请求出 现，就立即使用这些空余的子进程进行处理，
这样就不存在生成子进程造成的延迟了。这些服务器副本在处理完一次HTTP请求之后并不立即退出，而是停留在计 算机中等待下次请求。
对于客户浏览器的请求反应更快，性能较高。

apache模块的DLL：
该运行模式是我们以前在windows环境下使用apache服务器经常使用的，而在模块化(DLL)中，PHP是与Web服务器一起启动并运行的。
（是apache在CGI的基础上进行的一种扩展，加快PHP的运行效率）

#### ISAPI

ISAPI（Internet Server Application Program Interface）是微软提供的一套面向Internet服务的API接口。一个ISAPI的DLL，
可以在被用户请求激活后长驻内存，等待用户的另一个请求，还可以在一个DLL里设置多个用户请求处理函数，
此外，ISAPI的DLL应用程序和WWW服务器处于同一个进程中，效率要显著高于CGI。（由于微软的排他性，只能运行于windows环境） 

<br/><br/><br/><br/><br/>
### 参考资料

PHP 五大运行模式 <https://www.cnblogs.com/xuey/p/10059050.html>

PHP 运行模式 <https://segmentfault.com/a/1190000014547406>

PHP 的命令行模式 <https://www.php.net/manual/zh/features.commandline.php>

php常见的四种运行模式（SAPI） <https://blog.csdn.net/zhuocr/article/details/60328967>

Laruence sapi博文 <http://www.laruence.com/tag/sapi>

深入理解Zend SAPIs(Zend SAPI Internals)　<http://www.laruence.com/2008/08/12/180.html>

PHP 手册 安装与配置 Unix 系统下的安装 Unix 系统下的 Nginx 1.4.x  <https://www.php.net/manual/zh/install.unix.nginx.php>

PHP 手册 安装与配置 Unix 系统下的安装 CGI 和命令行设置 <https://www.php.net/manual/zh/install.unix.commandline.php>

PHP 手册 安装与配置 Unix 系统下的安装 Debian GNU/Linux 安装说明 <https://www.php.net/manual/zh/install.unix.debian.php>

PHP 手册 安装与配置 FastCGI 进程管理器（FPM） <https://www.php.net/manual/zh/install.fpm.php>

PHP 手册 安全 以 CGI 模式安装时 <https://www.php.net/manual/zh/security.cgi-bin.php>

php-fpm进程数管理 <https://segmentfault.com/a/1190000015612563>


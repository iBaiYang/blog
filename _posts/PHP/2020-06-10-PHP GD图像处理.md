---
layout: post
categories: PHP
title: PHP GD图像处理
meta: PHP GD图像处理
---
* content
{:toc}

## 正文

查找文件 php.ini 的位置：

浏览器页面：

```
phpinfo();
```

可以使用 `php --ini` 来定位到 php.ini 的绝对路径。

命令行：

```
> sudo find / -name php.ini
```

### 图片缩放

```php
<?php
/**
 * 用于对图片进行缩放并保存
 * @param $filename
 * @param $file_extension
 * @param int $width
 * @param int $height
 */
function thumb($filename, $file_extension, $width=0, $height=0)
{
    //获取原图像$filename的宽度$width_orig和高度$height_orig
    list($width_orig, $height_orig) = getimagesize($filename);
    //根据参数$width和$height值，换算出等比例缩放的高度和宽度
    if ($width && ($width_orig<$height_orig)) {
        $width = ($height/$height_orig)*$width_orig;
    } else {
        $height = ($width / $width_orig)*$height_orig;
    }

    //将原图缩放到这个新创建的图片资源中
    $image_p = imagecreatetruecolor($width, $height);
    //获取原图的图像资源
    if (strtolower($file_extension) == 'png') {
        $image = imagecreatefrompng($filename);
    } elseif (strtolower($file_extension) == 'jpg' || strtolower($file_extension) == 'jpeg') {
        $image = imagecreatefromjpeg($filename);
    }


    //使用imagecopyresampled()函数进行缩放设置
    imagecopyresampled($image_p,$image,0,0,0,0,$width,$height,$width_orig,$height_orig);

    //将缩放后的图片$image_p保存，100(质量最佳，文件最大)
    if (strtolower($file_extension) == 'png') {
        imagepng($image_p, $filename);
    } else if(strtolower($file_extension) == 'jpg' || strtolower($file_extension) == 'jpeg') {
        imagejpeg($image_p, $filename);
    }

    imagedestroy($image_p);
    imagedestroy($image);
}
```

看一个封装好的例子：
```php
<?php
class ImageService
{
    /**
     * 缩放图片处理
     * @param $filename
     * @param $file_extension
     * @param int $width
     * @param int $height
     * @return string
     */
    public static function thumbDeal($filename, $file_extension, $width = 0, $height = 0)
    {
        list($width_orig, $height_orig) = getimagesize($filename);
        if ($width && ($width_orig < $height_orig)) {
            $width = ($height / $height_orig) * $width_orig;
        } else {
            $height = ($width / $width_orig) * $height_orig;
        }

        $image_p = imagecreatetruecolor($width, $height);

        $image = null;
        if (strtolower($file_extension) == 'png') {
            $image = imagecreatefrompng($filename);
        } elseif (strtolower($file_extension) == 'jpg' || strtolower($file_extension) == 'jpeg') {
            $image = imagecreatefromjpeg($filename);
        }

        imagecopyresampled($image_p, $image, 0, 0, 0, 0, $width, $height, $width_orig, $height_orig);

        ob_start();
        if (strtolower($file_extension) == 'png') {
            imagepng($image_p);
        } else if (strtolower($file_extension) == 'jpg' || strtolower($file_extension) == 'jpeg') {
            imagejpeg($image_p);
        }

        imagedestroy($image_p);
        imagedestroy($image);

        $stream = ob_get_contents();
        ob_end_clean();

        return $stream;
    }

    /**
     * 缩放图片并保存
     * @param $filename   源文件地址
     * @param $file_extension   文件类型，png、jpg、jpeg
     * @param $destination   目的文件地址
     * @param int $width    目的宽度
     * @param int $height    目的高度
     * @return bool
     */
    public static function thumbSave($filename, $file_extension, $destination, $width = 0, $height = 0)
    {
        $stream = self::thumbDeal($filename, $file_extension, $width, $height);

        $file = fopen($destination, "w");
        fwrite($file, $stream);
        fclose($file);

        return true;
    }
}
```

如果你并不知道图片格式是png，还是jpg呢？下面处理：
```php
<?php
class ImageService
{
    /**
     * 缩放图片处理
     * @param $filename
     * @param int $width
     * @param int $height
     * @return string
     */
    public static function thumbDeal($filename, $width = 0, $height = 0)
    {
        list($width_orig, $height_orig) = getimagesize($filename);
        if ($width && ($width_orig < $height_orig)) {
            $width = ($height / $height_orig) * $width_orig;
        } else {
            $height = ($width / $width_orig) * $height_orig;
        }

        $image_p = imagecreatetruecolor($width, $height);

        $contents = file_get_contents($filename);
        $image = imagecreatefromstring($contents);

        imagecopyresampled($image_p, $image, 0, 0, 0, 0, $width, $height, $width_orig, $height_orig);

        ob_start();
        imagepng($image_p);

        imagedestroy($image_p);
        imagedestroy($image);

        $stream = ob_get_contents();
        ob_end_clean();

        return $stream;
    }

    /**
     * 缩放图片并保存
     * @param $filename   源文件地址
     * @param $destination   目的文件地址
     * @param int $width    目的宽度
     * @param int $height    目的高度
     * @return bool
     */
    public static function thumbSave($filename, $destination, $width = 0, $height = 0)
    {
        $stream = self::thumbDeal($filename, $width, $height);

        $file = fopen($destination, "w");
        fwrite($file, $stream);
        fclose($file);

        return true;
    }
}
```

### 二维码中间粘贴

有时会碰到需求，如把微信二维码中间替换为用户头像，如下处理：

```php
<?php
class ImageUtils
{
    /**
     * 获取图片资源
     * @param string $path
     * @return resource
     */
    public static function getGdImage($path = '')
    {
        $resource = imagecreatefromstring(file_get_contents($path));

        return $resource;
    }

    /**
     * 获取圆形的头像
     * @param string $path
     * @param int $width
     * @param int $height
     * @return resource
     */
    public static function getRoundAvatar($path = '', $width = 200, $height = 200)
    {

        $img = imagecreatetruecolor($width, $height);

        imagesavealpha($img, true);

        $bg = imagecolorallocatealpha($img, 255, 255, 255, 127);

        $originImg = self::getGdImage($path);

        // 先缩放再裁剪
        list($avatarWidth, $avatarHeight) = getimagesize($path);

        // 重新取样
        $sourceImg = imagecreatetruecolor($width, $height);
        imagecopyresampled($sourceImg, $originImg, 0, 0, 0, 0, $width, $height, $avatarWidth, $avatarHeight);

        $r = $width / 2;
        for ($x = 0; $x < $width; $x++) {
            for ($y = 0; $y < $height; $y++) {
                try {
                    $rgbColor = imagecolorat($sourceImg, $x, $y);
                } catch (\Exception $e) {
                    continue;
                }
                imagefill($img, $x, $y, $bg);  // 替换成白色
                imagecolortransparent($img, $bg);  // 将原图颜色替换为透明色
                if (((($x - $r) * ($x - $r) + ($y - $r) * ($y - $r)) < ($r * $r))) {
                    imagesetpixel($img, $x, $y, $rgbColor);
                }
            }
        }

        return $img;
    }

    /**
     * 获取带头像的小程序码
     * @param $qrCodePath
     * @param $avatarPath
     * @param int $width
     * @param int $height
     * @return resource
     */
    public static function genAvatarQrCode($qrCodePath, $avatarPath, $width = 200, $height = 200)
    {
        $avatarImg = self::getRoundAvatar($avatarPath, $width, $height);

        $qrCodeImg = self::getGdImage($qrCodePath);

        list($qrCodeWidth, $qrCodeHeight) = getimagesize($qrCodePath);

        $x = ($qrCodeWidth - $width) / 2;
        $y = ($qrCodeHeight - $height) / 2;

        imagecopymerge($qrCodeImg, $avatarImg, $x, $y, 0, 0, $width, $height, 100);

        return $qrCodeImg;
    }

    /**
     * 获取带头像的小程序码
     * @param $qrCodeStream  stream
     * @param $avatarPath
     * @param int $width
     * @param int $height
     * @return resource
     */
    public static function pasteAvatar($qrCodeStream, $avatarPath, $width = 200, $height = 200)
    {
        $avatarImg = self::getRoundAvatar($avatarPath, $width, $height);

        $qrCodeImg = imagecreatefromstring($qrCodeStream);

        list($qrCodeWidth, $qrCodeHeight) = getimagesize($qrCodeImg);
//        $qrCodeWidth = imagesx($qrCodeImg);
//        $qrCodeHeight = imagesy($qrCodeImg);

        $x = ($qrCodeWidth - $width) / 2;
        $y = ($qrCodeHeight - $height) / 2;

        imagecopymerge($qrCodeImg, $avatarImg, $x, $y, 0, 0, $width, $height, 100);

        return $qrCodeImg;
    }
}
```




<br/><br/><br/><br/><br/>
## 参考资料

图像处理和 GD <https://www.php.net/manual/zh/book.image.php>

PHP图像处理（GD库） <https://blog.csdn.net/wangdaxia163/article/details/98536467>

tp5.1 生成小程序码 并替换 中间的 logo(默认是小程序的头像) <https://blog.csdn.net/zhangwjshan/article/details/113779509>

---
layout: post
categories: PHP
title: PHP 对图像进行缩放
meta: 有时对图像进行缩放，有必要记录一下。
---
* content
{:toc}

### 正文

看一个图片上传并缩放的例子：
```
public function actionAvatarEdit()
{
     if ( $_FILES['imageFile'] ) {
          $upload_dir = Yii::$app->basePath . '/web/uploads/resource/';
          $file_extension = substr($_FILES['imageFile']['name'], strrpos($_FILES['imageFile']['name'], '.') + 1); // 后缀名
          $upload_file = date("YmdHis") . rand(10000,99999) . '.' . $file_extension;
          if ( !move_uploaded_file( $_FILES['imageFile']['tmp_name'], $upload_dir.$upload_file ) ) {
               return 0;
          }

          $files_upload = '/uploads/resource/';
         $this->thumb($upload_dir.$upload_file, $file_extension, 100, 100);

          $data = Admin::findOne( Yii::$app->user->id );
          $data->avatar = $files_upload . $upload_file;

         if ( $data->save() ) {
              return $files_upload . $upload_file;
          }
     }

     return 0;
}
```

```
protected function thumb( $filename, $file_extension, $width = 0, $height = 0 )
{
     // 获取原图像$filename的宽度$width_orig和高度$height_orig
     list($width_orig, $height_orig) = getimagesize($filename);
     // 根据参数$width和$height值，换算出等比例缩放的高度和宽度
     if ( $width && ($width_orig < $height_orig) ) {
          $width = ($height / $height_orig) * $width_orig;
     } else {
          $height = ($width / $width_orig) * $height_orig;
     }

     // 将原图缩放到这个新创建的图片资源中
     $image_p = imagecreatetruecolor($width, $height);
     // 获取原图的图像资源
     if ( strtolower($file_extension) == 'png' ) {
          $image = imagecreatefrompng($filename);
     } else if(strtolower($file_extension) == 'jpg' || strtolower($file_extension) == 'jpeg' ) {
          $image = imagecreatefromjpeg($filename);
     }

     // 使用imagecopyresampled()函数进行缩放设置
     imagecopyresampled( $image_p, $image, 0, 0, 0, 0, $width, $height, $width_orig, $height_orig );

     // 将缩放后的图片$image_p保存，100(质量最佳，文件最大)
     if ( strtolower($file_extension) == 'png' ) {
          imagepng($image_p, $filename);
     } elseif ( strtolower($file_extension) == 'jpg' || strtolower($file_extension ) == 'jpeg' ) {
          imagejpeg($image_p, $filename);
     }

     imagedestroy($image_p);
     imagedestroy($image);
} 
```


<br/><br/><br/><br/><br/>
### 源码

<pre style="background-color:#272822;color:#f8f8f2;font-family:'source Code pro';font-size:12.0pt;">
<span style="color:#75715e;"><br></span><span style="color:#66d9ef;">public function </span><span style="color:#a6e22e;">actionAvatarEdit</span>()<br>
{<br>
&nbsp;&nbsp;&nbsp;&nbsp;    <span style="color:#66d9ef;">if </span>( <span style="color:#ffffff;">$_FILES[</span><span style="color:#ffde6b;">'imageFile'</span><span style="color:#ffffff;">] </span>) {<br>
        <span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;       $upload_dir </span><span style="color:#f72671;">= </span><span style="color:#ffffff;">Yii</span><span style="color:#f72671;">::</span><span style="color:#ffffff;font-style:italic;">$app</span><span style="color:#f72671;">-&gt;</span><span style="color:#ae81ff;font-weight:bold;">basePath </span><span style="color:#f72671;">. </span><span style="color:#ffde6b;">'/web/uploads/resource/'</span><span style="color:#ffffff;">;<br></span><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;</span><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;    $file_extension </span><span style="color:#f72671;">= </span><span style="color:#66d9ef;">substr</span>(<span style="color:#ffffff;">$_FILES[</span><span style="color:#ffde6b;">'imageFile'</span><span style="color:#ffffff;">][</span><span style="color:#ffde6b;">'name'</span><span style="color:#ffffff;">], </span><span style="color:#66d9ef;">strrpos</span>(<span style="color:#ffffff;">$_FILES[</span><span style="color:#ffde6b;">'imageFile'</span><span style="color:#ffffff;">][</span><span style="color:#ffde6b;">'name'</span><span style="color:#ffffff;">], </span><span style="color:#ffde6b;">'.'</span>) <span style="color:#f72671;">+ </span><span style="color:#ae81ff;">1</span>)<span style="color:#ffffff;">;  </span><span style="color:#75715e;">// </span><span style="color:#75715e;font-family:'宋体';">后缀名<br></span><span style="color:#75715e;font-family:'宋体';">        </span><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;</span><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;    $upload_file </span><span style="color:#f72671;">= </span><span style="color:#66d9ef;">date</span>(<span style="color:#ffde6b;">"YmdHis"</span>) <span style="color:#f72671;">. </span><span style="color:#66d9ef;">rand</span>(<span style="color:#ae81ff;">10000</span><span style="color:#ffffff;">,</span><span style="color:#ae81ff;">99999</span>) <span style="color:#f72671;">. </span><span style="color:#ffde6b;">'.' </span><span style="color:#f72671;">. </span><span style="color:#ffffff;">$file_extension;<br></span><span style="color:#ffffff;">        </span><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;</span><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;    if </span>( <span style="color:#f72671;">!</span><span style="color:#66d9ef;">move_uploaded_file</span>( <span style="color:#ffffff;">$_FILES[</span><span style="color:#ffde6b;">'imageFile'</span><span style="color:#ffffff;">][</span><span style="color:#ffde6b;">'tmp_name'</span><span style="color:#ffffff;">], $upload_dir</span><span style="color:#f72671;">.</span><span style="color:#ffffff;">$upload_file </span>) ) {<br>
            <span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    </span><span style="color:#66d9ef;"><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;</span></span><span style="color:#66d9ef;"><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;    </span>return </span><span style="color:#ae81ff;">0</span><span style="color:#ffffff;">;<br></span><span style="color:#ffffff;">        </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;    }<br>
<br>
        <span style="color:#ffffff;">&nbsp;&nbsp;</span><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;    $files_upload </span><span style="color:#f72671;">= </span><span style="color:#ffde6b;">'/uploads/resource/'</span><span style="color:#ffffff;">;<br></span><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;        $this</span><span style="color:#f72671;">-&gt;</span><span style="color:#ffffff;">thumb</span>(<span style="color:#ffffff;">$upload_dir</span><span style="color:#f72671;">.</span><span style="color:#ffffff;">$upload_file, $file_extension, </span><span style="color:#ae81ff;">100</span><span style="color:#ffffff;">, </span><span style="color:#ae81ff;">100</span>)<span style="color:#ffffff;">;<br></span><span style="color:#ffffff;"><br></span><span style="color:#ffffff;">&nbsp;&nbsp;</span><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;    $data </span><span style="color:#f72671;">= </span><span style="color:#ffffff;">Admin</span><span style="color:#f72671;">::</span><span style="color:#a6e22e;font-style:italic;">findOne</span>( <span style="color:#ffffff;">Yii</span><span style="color:#f72671;">::</span><span style="color:#ffffff;font-style:italic;">$app</span><span style="color:#f72671;">-&gt;</span><span style="color:#ae81ff;font-weight:bold;">user</span><span style="color:#f72671;">-&gt;</span><span style="color:#ae81ff;font-weight:bold;">id </span>)<span style="color:#ffffff;">;<br></span><span style="color:#ffffff;">&nbsp;&nbsp;</span><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;    $data</span><span style="color:#f72671;">-&gt;</span><span style="color:#ae81ff;font-weight:bold;">avatar </span><span style="color:#f72671;">= </span><span style="color:#ffffff;">$files_upload </span><span style="color:#f72671;">. </span><span style="color:#ffffff;">$upload_file;<br></span><span style="color:#ffffff;"><br></span><span style="color:#ffffff;">        </span><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;        if </span>( <span style="color:#ffffff;">$data</span><span style="color:#f72671;">-&gt;</span><span style="color:#ffffff;">save</span>() ) {<br>
            <span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;           return </span><span style="color:#ffffff;">$files_upload </span><span style="color:#f72671;">. </span><span style="color:#ffffff;">$upload_file;<br></span><span style="color:#ffffff;">        </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;    }<br>
    &nbsp;&nbsp;&nbsp;&nbsp;    }<br>
<br>
    <span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    return </span><span style="color:#ae81ff;">0</span><span style="color:#ffffff;">;<br></span>}<br>
<br>
<span style="color:#75715e;"><br></span><span style="color:#66d9ef;">protected function </span><span style="color:#a6e22e;">thumb</span>( <span style="color:#ffffff;">$filename, $file_extension, $width </span><span style="color:#f72671;">= </span><span style="color:#ae81ff;">0</span><span style="color:#ffffff;">, $height </span><span style="color:#f72671;">= </span><span style="color:#ae81ff;">0 </span>)<br>
{<br>
    <span style="color:#75715e;">&nbsp;&nbsp;&nbsp;&nbsp;    // </span><span style="color:#75715e;font-family:'宋体';">获取原图像</span><span style="color:#75715e;">$filename</span><span style="color:#75715e;font-family:'宋体';">的宽度</span><span style="color:#75715e;">$width_orig</span><span style="color:#75715e;font-family:'宋体';">和高度</span><span style="color:#75715e;">$height_orig<br></span><span style="color:#75715e;">    </span><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    list</span>(<span style="color:#ffffff;">$width_orig, $height_orig</span>) <span style="color:#f72671;">= </span><span style="color:#66d9ef;">getimagesize</span>(<span style="color:#ffffff;">$filename</span>)<span style="color:#ffffff;">;<br></span><span style="color:#ffffff;">    </span><span style="color:#75715e;">&nbsp;&nbsp;&nbsp;&nbsp;    // </span><span style="color:#75715e;font-family:'宋体';">根据参数</span><span style="color:#75715e;">$width</span><span style="color:#75715e;font-family:'宋体';">和</span><span style="color:#75715e;">$height</span><span style="color:#75715e;font-family:'宋体';">值，换算出等比例缩放的高度和宽度<br></span><span style="color:#75715e;font-family:'宋体';">    </span><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    if </span>( <span style="color:#ffffff;">$width </span><span style="color:#f72671;">&amp;&amp; </span>(<span style="color:#ffffff;">$width_orig </span><span style="color:#f72671;">&lt; </span><span style="color:#ffffff;">$height_orig</span>) ) {<br>
        <span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;&nbsp;&nbsp;    $width </span><span style="color:#f72671;">= </span>(<span style="color:#ffffff;">$height </span><span style="color:#f72671;">/ </span><span style="color:#ffffff;">$height_orig</span>) <span style="color:#f72671;">* </span><span style="color:#ffffff;">$width_orig;<br></span><span style="color:#ffffff;">    </span>&nbsp;&nbsp;&nbsp;&nbsp;    } <span style="color:#66d9ef;">else </span>{<br>
        <span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;    &nbsp;&nbsp;&nbsp;&nbsp;    $height </span><span style="color:#f72671;">= </span>(<span style="color:#ffffff;">$width </span><span style="color:#f72671;">/ </span><span style="color:#ffffff;">$width_orig</span>) <span style="color:#f72671;">* </span><span style="color:#ffffff;">$height_orig;<br></span><span style="color:#ffffff;">    </span>&nbsp;&nbsp;&nbsp;&nbsp;    }<br>
<br>
    <span style="color:#75715e;">&nbsp;&nbsp;&nbsp;&nbsp;    // </span><span style="color:#75715e;font-family:'宋体';">将原图缩放到这个新创建的图片资源中<br></span><span style="color:#75715e;font-family:'宋体';">    </span><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;    $image_p </span><span style="color:#f72671;">= </span><span style="color:#66d9ef;">imagecreatetruecolor</span>(<span style="color:#ffffff;">$width, $height</span>)<span style="color:#ffffff;">;<br></span><span style="color:#ffffff;">    </span><span style="color:#75715e;">&nbsp;&nbsp;&nbsp;&nbsp;    // </span><span style="color:#75715e;font-family:'宋体';">获取原图的图像资源<br></span><span style="color:#75715e;font-family:'宋体';">    </span><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    if </span>( <span style="color:#66d9ef;">strtolower</span>(<span style="color:#ffffff;">$file_extension</span>) <span style="color:#f72671;">== </span><span style="color:#ffde6b;">'png' </span>) {<br>
        <span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;    </span><span style="color:#ffffff;"><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    </span>$image </span><span style="color:#f72671;">= </span><span style="color:#66d9ef;">imagecreatefrompng</span>(<span style="color:#ffffff;">$filename</span>)<span style="color:#ffffff;">;<br></span><span style="color:#ffffff;">    </span>&nbsp;&nbsp;&nbsp;&nbsp;    } <span style="color:#66d9ef;">else if</span>(<span style="color:#66d9ef;">strtolower</span>(<span style="color:#ffffff;">$file_extension</span>) <span style="color:#f72671;">== </span><span style="color:#ffde6b;">'jpg' </span><span style="color:#f72671;">|| </span><span style="color:#66d9ef;">strtolower</span>(<span style="color:#ffffff;">$file_extension</span>) <span style="color:#f72671;">== </span><span style="color:#ffde6b;">'jpeg' </span>) {<br>
        <span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;    </span><span style="color:#ffffff;"><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    </span>$image </span><span style="color:#f72671;">= </span><span style="color:#66d9ef;">imagecreatefromjpeg</span>(<span style="color:#ffffff;">$filename</span>)<span style="color:#ffffff;">;<br></span><span style="color:#ffffff;">    </span>&nbsp;&nbsp;&nbsp;&nbsp;    }<br>
<br>
    <span style="color:#75715e;">&nbsp;&nbsp;&nbsp;&nbsp;    // </span><span style="color:#75715e;font-family:'宋体';">使用</span><span style="color:#75715e;">imagecopyresampled()</span><span style="color:#75715e;font-family:'宋体';">函数进行缩放设置<br></span><span style="color:#75715e;font-family:'宋体';">    </span><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    imagecopyresampled</span>( <span style="color:#ffffff;">$image_p, $image, </span><span style="color:#ae81ff;">0</span><span style="color:#ffffff;">, </span><span style="color:#ae81ff;">0</span><span style="color:#ffffff;">, </span><span style="color:#ae81ff;">0</span><span style="color:#ffffff;">, </span><span style="color:#ae81ff;">0</span><span style="color:#ffffff;">, $width, $height, $width_orig, $height_orig </span>)<span style="color:#ffffff;">;<br></span><span style="color:#ffffff;"><br></span><span style="color:#ffffff;">    </span><span style="color:#75715e;">&nbsp;&nbsp;&nbsp;&nbsp;    // </span><span style="color:#75715e;font-family:'宋体';">将缩放后的图片</span><span style="color:#75715e;">$image_p</span><span style="color:#75715e;font-family:'宋体';">保存，</span><span style="color:#75715e;">100(</span><span style="color:#75715e;font-family:'宋体';">质量最佳，文件最大</span><span style="color:#75715e;">)<br></span><span style="color:#75715e;">    </span><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    if </span>( <span style="color:#66d9ef;">strtolower</span>(<span style="color:#ffffff;">$file_extension</span>) <span style="color:#f72671;">== </span><span style="color:#ffde6b;">'png' </span>) {<br>
        <span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    </span><span style="color:#66d9ef;"><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    </span>imagepng</span>(<span style="color:#ffffff;">$image_p, $filename</span>)<span style="color:#ffffff;">;<br></span><span style="color:#ffffff;">    </span>&nbsp;&nbsp;&nbsp;&nbsp;    } <span style="color:#66d9ef;">elseif </span>( <span style="color:#66d9ef;">strtolower</span>(<span style="color:#ffffff;">$file_extension</span>) <span style="color:#f72671;">== </span><span style="color:#ffde6b;">'jpg' </span><span style="color:#f72671;">|| </span><span style="color:#66d9ef;">strtolower</span>(<span style="color:#ffffff;">$file_extension </span>) <span style="color:#f72671;">== </span><span style="color:#ffde6b;">'jpeg' </span>) {<br>
        <span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    </span><span style="color:#66d9ef;"><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    </span>imagejpeg</span>(<span style="color:#ffffff;">$image_p, $filename</span>)<span style="color:#ffffff;">;<br></span><span style="color:#ffffff;">    </span>&nbsp;&nbsp;&nbsp;&nbsp;    }<br>
<br>
    <span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    imagedestroy</span>(<span style="color:#ffffff;">$image_p</span>)<span style="color:#ffffff;">;<br></span><span style="color:#ffffff;">    </span><span style="color:#66d9ef;">&nbsp;&nbsp;&nbsp;&nbsp;    imagedestroy</span>(<span style="color:#ffffff;">$image</span>)<span style="color:#ffffff;">;<br></span>}
</pre>







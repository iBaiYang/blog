---
layout: post
categories: PHP
title: PHP base64编码
meta: PHP base64编码
---
* content
{:toc}

## 正文

如果一个应用中插入另一个应用H5的服务，怎么解决认证的问题？

新应用需要确认入口应用是可信的：入口应用带一个认证字段进入新应用，新应用带着这个认证字段去入口应用确认服务。

我们可以对一个数组json后hash_hmac生成token，把token加入数组，然后对这个数组json后base64编码。

先准备可用于URL传递的base64编码方法：
```
function base64url_encode($data) {
  return rtrim(strtr(base64_encode($data), '+/', '-_'), '=');
}

function base64url_decode($data) {
  return base64_decode(str_pad(strtr($data, '-_', '+/'), strlen($data) % 4, '=', STR_PAD_RIGHT));
}
```

生成过程如下：
```
$arr = [
    "user_id" => 1221,
    "app_id" => 342156,
    "time" => 1629958838
];

$app_key = "94a08da1fecbb6e8b46990538c7b50b2";
// 生成sign
$sign = hash_hmac('sha256', json_encode($arr), $app_key);

$arr = array_merge($arr, ["sign" => $sign]);
$str = json_encode($arr);

$str_url = base64url_encode($str);
```

认证过程如下：
```
$str_url = "eyJ1c2VyX2lkIjoxMjIxLCJhcHBfaWQiOjM0MjE1NiwidGltZSI6MTYyOTk1ODgzOCwic2lnbiI6ImVhMjU0MmJlNmVmOWQxNTZlNDMwOWFlOWU4ZTNhODIwNTZiNjI2MjExOWI2NzNlNjVmOGM2OWY4NjBlOWY4ZDIifQ";
 
$str = base64url_decode($str_url);

$arr = json_decode($str, true);

$sign = $arr["sign"];
unset($arr["sign"]);

if (hash_hmac('sha256', json_encode($arr), $app_key) != $sign) {
    echo "认证失败";
}
```

### URL 函数

    base64_decode — 对使用 MIME base64 编码的数据进行解码
    base64_encode — 使用 MIME base64 对数据进行编码
    get_headers — 取得服务器响应一个 HTTP 请求所发送的所有标头
    get_meta_tags — 从一个文件中提取所有的 meta 标签 content 属性，返回一个数组
    http_build_query — 生成 URL-encode 之后的请求字符串
    parse_url — 解析 URL，返回其组成部分
    rawurldecode — 对已编码的 URL 字符串进行解码
    rawurlencode — 按照 RFC 3986 对 URL 进行编码
    urldecode — 解码已编码的 URL 字符串
    urlencode — 编码 URL 字符串

## 参考资料

PHP 手册 函数参考 其它基本扩展 URLs URL 函数 <https://www.php.net/manual/zh/ref.url.php>

PHP 手册 函数参考 加密扩展 哈希信息摘要框架 <https://www.php.net/manual/zh/book.hash.php>

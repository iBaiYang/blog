---
layout: post
categories: PHP
title: PHP 防SQL注入技术
meta: SQL注入是项目建设必须要考虑的问题，一般所用框架对接受或执行的SQL语句都进行了预处理，但如果要你自己处理呢？下面说一下。
---
* content
{:toc}

### 正文

SQL注入是项目建设必须要考虑的问题，一般所用框架对接受或执行的SQL语句都进行了预处理，但如果要你自己处理呢？下面说一下。

addslashes()、 mysql_real_escape_string()、mysql_escape_string()等函数，可将特殊字符和可能引起数据库操作出错的字符转义。

#### 魔术引号
为了防止SQL注入攻击，PHP自带一个功能可以对输入的字符串进行处理，
可以在较底层对输入进行安全上的初步处理，也即Magic Quotes。
(当php.ini里的magic_quotes_gpc=On时。
提交的变量中所有的单引号(')、双引号(")、反斜线(\)与 NUL(NULL 字符)会自动转为含有反斜线的转义字符。)。
如果magic_quotes_gpc选项启用，那么输入的字符串中的单引号，双引号和其它一些字符前将会被自动加上反斜杠\。
但Magic Quotes并不是一个很通用的解决方案，没能屏蔽所有有潜在危险的字符，
并且在许多服务器上Magic Quotes并没有被启用。所以，我们还需要使用其它多种方法来防止SQL注入。

#### addslashes()
addslashes() 函数返回在预定义字符之前添加反斜杠的字符串。

预定义字符是：单引号（'）、双引号（"）、反斜杠（\）、NULL

如：
```
$str = addslashes('Shanghai is the "biggest" city in China.');
echo($str);  // Shanghai is the \"biggest\" city in China. 
```

这个函数的作用和magic_quotes_gpc一样。所以一般用addslashes前会检查是否开了magic_quotes_gpc。

```
if (!get_magic_quotes_gpc()) {
    $lastname = addslashes($_POST[‘lastname’]);
} else {
    $lastname = $_POST[‘lastname’];
}
```

magic_quotes_gpc与addslashes的区别用法：
```
1)对于magic_quotes_gpc=on的情况
我们可以不对输入和输出数据库的字符串数据作addslashes()和stripslashes()的操作,数据也会正常显示。
如果此时你对输入的数据作了addslashes()处理，那么在输出的时候就必须使用stripslashes()去掉多余的反斜杠。

2)对于magic_quotes_gpc=off 的情况
必须使用addslashes()对输入数据进行处理，但并不需要使用stripslashes()格式化输出，
因为addslashes()并未将反斜杠一起写入数据库，只是帮助mysql完成了sql语句的执行。
```

需要特别提醒的是addslashes并不完美。addslashes的问题在于黑客可以用0xbf27来代替单引号，
而addslashes只是将0xbf27修改为0xbf5c27，成为一个有效的多字节字符，
其中的0xbf5c仍会被看作是单引号，所以addslashes无法成功拦截。

当然addslashes也不是毫无用处，它是用于单字节字符串的处理，多字节字符还是用mysql_real_escape_string吧。

#### mysql_real_escape_string()

mysql_real_escape_string 必须在(PHP 4 >= 4.3.0, PHP 5)的情况下才能使用，否则只能用 mysql_escape_string。
两者的区别是：mysql_real_escape_string 考虑到连接的当前字符集，而mysql_escape_string 不考虑。

mysql_real_escape_string() 函数转义 SQL 语句中使用的字符串中的特殊字符。

下列字符受影响：
```
    \x00
    \n
    \r
    \
    '
    "
    \x1a
```

如果成功，则该函数返回被转义的字符串。如果失败，则返回 false。

本扩展自 PHP5.5.0 起已废弃，并在自 PHP 7.0.0 开始被移除。

因为完全性问题，建议使用拥有Prepared Statement机制的PDO和MYSQLi来代替mysql_query，
使用的是mysqli_real_escape_string。

#### 正则匹配替换
我们也可以自己写敏感字符替换函数，用preg_match、preg_match_all()、preg_replace()来实现。

#### htmlspecialchars()
htmlspecialchars()将特殊字符转换为 HTML 实体。

```
字符 	替换后

& (& 符号) 	&amp;

" (双引号) 	&quot;，除非设置了 ENT_NOQUOTES

' (单引号) 	设置了 ENT_QUOTES 后， &#039; (如果是 ENT_HTML401) ，或者 &apos; (如果是 ENT_XML1、 ENT_XHTML 或 ENT_HTML5)。

< (小于) 	&lt;

> (大于) 	&gt;
```

如：
```
$new = htmlspecialchars("<a href='test'>Test</a>", ENT_QUOTES);
echo $new; // &lt;a href=&#039;test&#039;&gt;Test&lt;/a&gt;
```

可以看出htmlspecialchars()重点用在 HTML 文档环境，基本并不使用在防止 SQL 注入里。

#### 参数化绑定
参数化绑定，防止 SQL 注入的又一道屏障。php MySQLi 和 PDO 均提供这样的功能。

比如 MySQLi 可以这样去查询：
```
$mysqli = new mysqli('localhost', 'my_user', 'my_password', 'world');
$stmt = $mysqli->prepare("INSERT INTO CountryLanguage VALUES (?, ?, ?, ?)");
$code = 'DEU';
$language = 'Bavarian';
$official = "F";
$percent = 11.2;
$stmt->bind_param('sssd', $code, $language, $official, $percent);
```

PDO 的更是方便，比如：
```
/* Execute a prepared statement by passing an array of values */
$sql = 'SELECT name, colour, calories
    FROM fruit
    WHERE calories < :calories AND colour = :colour'; 
$sth = $dbh->prepare($sql, array(PDO::ATTR_CURSOR => PDO::CURSOR_FWDONLY));
$sth->execute(array(':calories' => 150, ':colour' => 'red'));
$red = $sth->fetchAll();
$sth->execute(array(':calories' => 175, ':colour' => 'yellow'));
$yellow = $sth->fetchAll();
```

绑定变量使用预编译语句是预防SQL注入的最佳方式，因为使用预编译的SQL语句语义不会发生改变，
在SQL语句中，变量用问号?表示，攻击者无法改变SQL语句的结构，从根本上杜绝了SQL注入攻击的发生。

#### 总结
* addslashes() 是强行加\；
* mysql_real_escape_string() 会判断字符集，但是对PHP版本有要求；
* mysql_escape_string不考虑连接的当前字符集。

一般框架都会把sql安全性这块考虑到，如果自己写sql就要严把安全关。这篇blog写的不好，有空重新整理一下。
另外也把Yii2的防sql注入实现总结一下。

<br/><br/><br/><br/><br/>
### 参考资料

SQL注入防御与绕过的几种姿势 <http://netsecurity.51cto.com/art/201705/538863.htm>

PHP几个防SQL注入攻击自带函数区别 <https://www.cnblogs.com/timelesszhuang/p/3744080.html>

php SQL 防注入的一些经验 <https://www.cnblogs.com/liuzhang/p/4753467.html>

mysql_real_escape_string <https://www.php.net/manual/zh/function.mysql-real-escape-string.php>

mysqli_real_escape_string <https://www.php.net/manual/zh/mysqli.real-escape-string.php>

addslashes() <http://www.php.net/manual/zh/function.addslashes.php>

sprintf() <http://www.w3school.com.cn/php/func_string_sprintf.asp>

htmlspecialchars() <http://php.net/manual/zh/function.htmlspecialchars.php>

htmlentities() <http://php.net/manual/zh/function.htmlentities.php>

preg_replace() <https://www.php.net/manual/zh/function.preg-replace.php>

PHP正则替换preg_replace函数的使用 <https://www.cnblogs.com/crxis/p/7714636.html>

Yii2 最佳安全实践 <https://www.yiichina.com/doc/guide/2.0/security-best-practices>

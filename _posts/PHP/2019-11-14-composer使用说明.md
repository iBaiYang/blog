---
layout: post
categories: PHP
title: composer使用说明
meta: composer使用说明
---
* content
{:toc}

## 正文

composer安装好后，我们就可以在项目中使用composer了。

在项目指定目录下新建 composer.json 文件，写入依赖的包，如：
```
{
    "require": {
        "php": ">=7.0.0",
        "yiisoft/yii2": "~2.0.15",
        "nmred/kafka-php": "0.2.*",
        "peachpear/pear-leaf": "1.0.*"
    }
}
```

然后cd到该层目录下执行 `composer install`，就进入自动安装，安装完成后会生成一个 composer.lock 文件，里面是特定的版本号名，
需要把这个文件和 composer.json 一起提交到版本管理里去。依赖包则全部安装到了项目根目录的verdor目录下。

第三方下载了包，包中有 composer.lock 文件，执行 `composer install`，会安装 composer.lock 文件锁定版本号的依赖包，
可以自动排除已安装的依赖包、只下载未安装的依赖包。

### 更新依赖

在 composer.lock 文件存在时，想更新依赖包的更高版本，可以使用 update 命令。

要更新你的依赖版本请使用 update 命令。这将获取最新匹配的版本（根据你的 composer.json 文件）并将新版本更新进锁文件。

更新依赖：
> composer update

如果只想更新部分依赖：
```
composer update peachpear/pear-leaf
```

在 composer.json 文件新加了包，可以使用install命令安装新增的包（composer足够智能，可以判断出哪些还没有安装）：
> composer install

安装完成后，会在 composer.lock 文件中写入包的版本等信息。

### 期间问题

#### bower插件问题

期间发现一个问题，Yii2安装时需要 `bower-asset/jquery 3.4.*@stable`：

![]({{site.baseurl}}/images/20191114/20191114113942.png)

需要引入 `bower-asset/jquery`，有两种方式：
```
// 全局安装
composer global require "fxp/composer-asset-plugin"
 
// 或者项目内引入
composer require --dev "fxp/composer-asset-plugin"
```

如果全局安装没效果，就项目内引入。

![]({{site.baseurl}}/images/20200605/20200605160127.png)

期间又发现另外一个问题，GitHub OAuth token or enter a new one to go over the API rate limit 。

![]({{site.baseurl}}/images/20191114/20191114124600.png)

提示中说明了获取地址： `https://github.com/settings/tokens/new?scopes=repo&description=Composer+on+pc+2019-11-14+1145` 。
我们通过浏览器打开，发现是生成token页面，选项也默认选择了，我们只要点击下方的确认就可以。

![]({{site.baseurl}}/images/20191114/20191114125210.png)

复制生成的token.在刚才执行的命令行中要token的地方粘贴并回车：

![]({{site.baseurl}}/images/20191114/20191114124634.png)

可以看到终于把所有依赖包都安装完毕。

#### composer版本问题

`composer install` 时报错：
```
Package fxp/composer-asset-plugin has a PHP requirement incompatible with your PHP
```

* 一个可能原因是因为 composer版本低了，如composer1.0.0的Package fxp/composer-asset-plugin与PHP版本(7.2.0)不兼容。

* 另一个可能原因是 composer包版本高了，我们到 packagist 中 查看fxp/composer-asset-plugin的环境要求：

```
 v1.4.6 2019-08-08 18:36 UTC

Requires
    php: >=5.3.3
    composer-plugin-api: ^1.0

Requires (Dev)
    composer/composer: ^1.6.0
```

如果我们的 composer 是 2.x 版本，那就卸载 composer 。

我们只要把composer文件移除就可以：
```
[root@BaiYang-PC src]# rm -f /usr/local/bin/composer
```

安装指定版本的 Composer：
```
[root@BaiYang-PC src]#
[root@BaiYang-PC src]# php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
[root@BaiYang-PC src]# php composer-setup.php --version=1.6.5
All settings correct for using Composer
Downloading...

Composer (version 1.6.5) successfully installed to: /usr/local/src/composer.phar
Use it: php composer.phar

[root@BaiYang-PC src]#
[root@BaiYang-PC src]#
[root@BaiYang-PC src]# mv composer.phar /usr/local/bin/composer
[root@BaiYang-PC src]#
```

安装 fxp/composer-asset-plugin 前端资源管理插件：
```
[root@BaiYang-PC src]# composer global require "fxp/composer-asset-plugin:~1.4"
Changed current directory to /root/.composer
Warning from https://packagist.org: Support for Composer 1 is deprecated and some packages will not be available. 
You should upgrade to Composer 2. See https://blog.packagist.com/deprecating-composer-1-support/



^C
[root@BaiYang-PC src]#
```

命令行停滞在这了，说 composer1 被抛弃了，已经不可使用了。看来 fxp/composer-asset-plugin 这个插件包是没办法安装使用了。

更新 composer ：
```
[root@BaiYang-PC src]# composer self-update
```

如果是安装Yii2需要 fxp/composer-asset-plugin 管理asset前端资源，我们可以按照 Yii2说明文档：
```
您可能希望通过本地 Bower/NPM 客户端管理您的 assets，使用 CDN 或完全避免 assets 的安装。 
为了防止通过 Composer 安装 assets，请将以下几行添加到您的 'composer.json' 中：

"replace": {
    "bower-asset/jquery": ">=1.11.0",
    "bower-asset/inputmask": ">=3.2.0",
    "bower-asset/punycode": ">=1.3.0",
    "bower-asset/yii2-pjax": ">=2.0.0"
},
```


#### SSL证书问题

<https://blog.csdn.net/w670328683/article/details/53442087>


### 移除依赖

移除指定依赖：

> composer remove yiisoft/yii2

不过这只是删除了依赖关系，不会自动加载，但其依赖包还在vender文件夹里，可手动删除。

### 版本说明

版本格式：主版本号.次版本号.修订号，版本号递增规则如下：
```
主版本号：当你做了不兼容的 API 修改，
次版本号：当你做了向下兼容的功能性新增，
修订号：当你做了向下兼容的问题修正。
```

先行版本号及版本编译元数据可以加到“主版本号.次版本号.修订号”的后面，作为延伸。

使用 ~ 约束符锁定小版本的方式， 使用 ^ 约束符锁定大版本
```
~表示版本号只能改变最末尾那段（如果是 ~x.y 末尾就是 y，如果是 ~x.y.z 末尾就是 z）
~1.2.3 代表 1.2.3 <= 版本号 < 1.3.0
~1.2   代表  1.2 <= 版本号 <2.0

^表示除了大版本号以外，小版本号和补丁版本号都可以变
^1.2.3 代表 1.2.3 <= 版本号 < 2.0.0

特殊情况0开头的版本号：
^0.3.0 等于 0.3.0 <= 版本号 <0.4.0  注意：不是 <1.0.0
因为：semantic versioning 的规定是，大版本号以 0 开头表示这是一个非稳定版本（unstable），
如果处于非稳定状态，小版本号是允许不向下兼容的，

所以如果你要指定 0 开头的库那一定要注意：
危险写法：~0.1 等于 0.1.0 <= 版本号 <1.0.0
保险写法：^0.1 等于 0.1.0 <= 版本号 <0.2.0
```

锁定版本范围：

有时候我们的使用场景要求只能安装某些版本范围内的时候，可以使用 `>、<、>=、<=、|` 这些符号来组合，比如：`>= 1.3 <1.6、>=1.3 | >=1.7 、3.0|4.0` 等。
这样的使用场景并不多，根据你的情况来调整用法就好。

### init初始化

在一个项目中，可以使用 `composer init` 进行项目初始化：
```
root@02891538d8c9:/var/www/html/test# composer init
The "fxp/composer-asset-plugin" plugin was skipped because it requires a Plugin API version ("^1.0") that does not match your Composer installation ("2.3.0"). You may need to run composer update with the "--no-plugins" option.


  Welcome to the Composer config generator



This command will guide you through creating your composer.json config.

Package name (<vendor>/<name>) [root/test]: test/test
Description []: test
Author [n to skip]: test
Minimum Stability []: 0.0.1
Invalid minimum stability "0.0.1". Must be empty or one of: stable, RC, beta, alpha, dev
Minimum Stability []: dev
Package Type (e.g. library, project, metapackage, composer-plugin) []: project
License []: PSL

Define your dependencies.

Would you like to define your dependencies (require) interactively [yes]? no
Would you like to define your dev dependencies (require-dev) interactively [yes]? no
Add PSR-4 autoload mapping? Maps namespace "Test\Test" to the entered relative path. [src/, n to skip]: yes
The src folder name "yes" is invalid. Please add a relative path with tailing forward slash. [A-Za-z0-9_-/]+/
Add PSR-4 autoload mapping? Maps namespace "Test\Test" to the entered relative path. [src/, n to skip]: src/

{
    "name": "test/test",
    "description": "test",
    "type": "project",
    "license": "PSL",
    "autoload": {
        "psr-4": {
            "Test\\Test\\": "src/"
        }
    },
    "authors": [
        {
            "name": "test"
        }
    ],
    "minimum-stability": "dev",
    "require": {}
}

Do you confirm generation [yes]? yes
The "fxp/composer-asset-plugin" plugin (installed globally) was skipped because it requires a Plugin API version ("^1.0") that does not match your Composer installation ("2.3.0"). You may need to run composer update with the "--no-plugins" option.
Generating autoload files
Generated autoload files
PSR-4 autoloading configured. Use "namespace Test\Test;" in src/
Include the Composer autoloader with: require 'vendor/autoload.php';
root@02891538d8c9:/var/www/html/test#
root@02891538d8c9:/var/www/html/test#
```

## 解惑

### fxp/composer-asset-plugin 是什么

fxp/composer-asset-plugin 是 Composer 的 NPM/Bower 依赖管理器。

2017 年 4 月份，也就是 yii2 的 2.0.12 版本中用 Asset Packagist 插件替换了 fxp/composer-asset-plugin。
所以，如果你用的是 yii2 2.0.12 及更新版本则不会遇到问题：
为什么基于 Yii2 创建的项目安装依赖包时即便设置了中国镜像依然很慢？
但是你会遇到下一个问题：为什么不为 Asset Packagist 创建中国镜像？

yii2 通过 fxp/composer-asset-plugin 插件来安装前端开发所用到依赖包，
此插件会在安装完 php 依赖包之后再安装前端开发所依赖的 npm 或 bower 包， 
但是，此插件默认行为是前往 Github 下载资源，从而绕开了中国镜像。
这就是为什么基于 Yii2 创建的项目安装依赖包时即便设置了中国镜像依然很慢的原因。

fxp/composer-asset-plugin 使用中国镜像来安装前端开发所用到依赖包。使用前需要先用 Composer 安装 fxp/composer-asset-plugin ：
> composer global require "fxp/composer-asset-plugin"



### Asset Packagist 是什么

Asset Packagist 这个仓库可以让 npm 和 bower 包作为 composer 原生包安装.

不 需要插件 不 需要Node.js.

我们已经添加了常用的 npm 和 bower 包.

搜索技巧：
* Npm库中不带有 scope 方式命名的包, 如`jquery`用`npm-asset/jquery`代替进行精准搜索.
* Npm库中以 scope 方式命名的包,将原生命名 `@scope/package`替换成 `scope--package` 格式进行搜索, 如. `npm-asset/pusher--chatkit`.

**用法**

用以下方法添加包:
```
"require": {
    "bower-asset/bootstrap": "^3.3",
    "npm-asset/jquery": "^2.2"
}
```

然后加入以下行:
```
"repositories": {

    {
        "type": "composer",
        "url": "https://asset-packagist.cn"
    }
}
```

**为什么要建这个仓库**

 fxp/composer-asset-plugin 用起来让人恼火。
它是一个非常有创意的项目，也是一个好的实现。
但是它有一些问题：当使用 `composer update` 时非常缓慢，而且需要全局安装一个插件, 这会影响所有项目.
与此同时，Travis 和 Scrutinizer 联合使用中也会有些奇葩问题, 令人抓狂。

**工作原理**

Asset Packagist 提供关于Bower和NPM包的信息，类似于Packagist为Composer包的信息。

因此，当您在启用资源包（Asset Package）的项目中运行composer，composer知道bower-asset和npm-asset包的所有可用版本，并知道如何下载它们的文件。

首先将 Bower 和 NPM 包 加入到我们自己的仓库中. 脚本会收集包信息并且以Packagist的格式处理json文件. 

该文件包含了该包的所有版本的说明，格式如下:
```
    "2.13.0.0": {
      "uid": 1000600,
      "name": "bower-asset/moment",
      "version": "2.13.0.0",
      "type": "bower-asset",
      "dist": {
        "type": "zip",
        "url": "https://api.github.com/repos/moment/moment/zipball/d6651c21c6131fbb5db891b60971357739015688",
        "reference": "d6651c21c6131fbb5db891b60971357739015688"
      },
      "source": {
        "type": "git",
        "url": "https://github.com/moment/moment.git",
        "reference": "d6651c21c6131fbb5db891b60971357739015688"
      }
    },
```

所以，当您运行composer时，它会下载Asset Packagist 库提供的包信息，然后 Composer 解析依赖项并找到所需包的正确版本，
然后将包文件下载到项目的vendor目录中 (实际上composer并不关心这些文件是PHP还是JS或其他文件).

所有的JSON文件都作为静态文件存储在 Asset Packagist 端， 项目中 Composer 会有效的找到这些文件，这样一切都能尽快完成。

**安装到自定义路径**

Asset Packagist 不是插件, 所以他不受 Composer的包安装位置所限制.

默认 `bower-asset/bootstrap` 包将会安装到 `vendor/bower-asset/bootstrap` 目录中.

你可以通过 `oomphinc/composer-installers-extender` 插件，来自定义安装路径，如:
```
    "require": {
        "oomphinc/composer-installers-extender": "^1.1",
        "bower-asset/bootstrap": "^3.3",
        "npm-asset/jquery": "^2.2"
    },
    "extra": {
        "installer-types": ["bower-asset", "npm-asset"],
        "installer-paths": {
            "public/assets/{$vendor}/{$name}/": ["type:bower-asset", "type:npm-asset"]
        }
    },
    "repositories": [
        {
            "type": "composer",
            "url": "https://asset-packagist.cn"
        }
    ]
```

**Yii2**

Yii2 默认会将 Bower 和 NPM 包 分别安装到 `vendor/bower` 和 `vendor/npm`目录中.

因此, 在Yii2项目中引用 asset-packagist, 必须在程序的配置文件中重新指定 Bower 和 NPM 别名的映射，如:
```
    $config = [
        ...
        'aliases' => [
            '@bower' => '@vendor/bower-asset',
            '@npm'   => '@vendor/npm-asset',
        ],
        ...
    ];
```

**从 composer-asset-plugin 迁移**

在同一台服务器中运行了多个应用时，从 [composer-asset-plugin](https://github.com/fxpio/composer-asset-plugin) 迁移是个麻烦事. 
你需要注意：当这个插件在全局安装时， asset packagist 与 asset plugin 同时存在会有冲突. 
所以, 为了不影响其他应用的情况下停掉这个插件, 你可以通过在 composer.json 文件中 config 选项中禁用掉这个插件。 
(你的 plugin 版本需要 ≥ 1.3.0 ):
```
    "config": {
        "fxp-asset": {
            "enabled": false
        }
    }
```

**为什么不为 Asset Packagist 创建中国镜像？**

首先，Asset Packagist 的目的也是为了解决在 php 项目中安装前端模块的问题，
其通过转换 npm / bower 模块并创建一个类似 packagist 的服务为前端模块提供依赖解析和下载。

yii2 2.0 版本发布于 2014 年，所以有着历史原因，然而随着 Node.js / npm 生态的完善和普及，
Asset Packagist 这种方式显得很笨拙，对前端开发没有任何益处，yii2 采用这种方式也只是为了向后兼容，
避免破坏现有框架的工作方式而已。

Asset Packagist 的存在意义已经很弱了，新的框架（例如 Laravel）对前端开发的支持直接构建在 npm 上的，
因此，Asset Packagist 镜像的存在的意义也很弱，中国区就没有为其提供镜像。



<br/><br/><br/><br/><br/>
## 参考资料

Composer 官网 <https://www.phpcomposer.com/>

Composer 文档 <https://docs.phpcomposer.com/>

镜像官网 <https://packagist.org/>

中国镜像官网 <https://pkg.phpcomposer.com/>

中国全量镜像 <https://pkg.xyz/>

fxp/composer-asset-plugin <https://github.com/fxpio/composer-asset-plugin>

Asset Packagist 官网 <https://asset-packagist.org/>

Asset Packagist 中文站 <https://asset-packagist.cn/>

Linux 下安装Composer <https://ibaiyang.github.io/blog/linux/2017/07/25/Linux-下安装Composer.html>

Composer —— A Dependency Manager for PHP <https://getcomposer.org/>

基本用法 - Composer 中文文档 - Composer 中文网 <https://docs.phpcomposer.com/01-basic-usage.html>

fxp/composer-asset-plugin <https://packagist.org/packages/fxp/composer-asset-plugin#v1.0.3>

语义化版本 2.0.0 <https://semver.org/lang/zh-CN/>

composer 版本号前置~与^符号的区别 <https://blog.csdn.net/eebaicai/article/details/88047833>

Composer安装和使用 <https://www.jianshu.com/p/256547b495c2>

composer.json 中的各个属性字段详解 <https://blog.zzstudio.net/bs/article_1098.html>

yii2 composer 下载扩展解决jquery版本错误 <https://blog.csdn.net/wpj130/article/details/88743232>

YII2 composer update 报错解决一例-requires bower-asset/jquery 2.2 <https://www.cnblogs.com/rxbook/p/11043900.html>

PHP 开发者该知道的 5 个 Composer 小技巧 <https://www.phpcomposer.com/5-features-to-know-about-composer-php/>

Composer 安装与使用 <https://www.runoob.com/w3cnote/composer-install-and-usage.html>

Composer 出现error:14090086的解决方案 <https://blog.csdn.net/w670328683/article/details/53442087>

packages fxp/composer-asset-plugin <http://packagist.p2hp.com/packages/fxp/composer-asset-plugin>

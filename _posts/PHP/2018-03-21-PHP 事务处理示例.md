---
layout: post
categories: PHP
title: PHP事务处理示例
meta: 在php中，事务场景我们经常会碰到。这里举一个例子。
---
* content
{:toc}

### 正文

在php中，事务场景我们经常会碰到。

下面举一个yii2中使用的标准的示例：

### 代码
```
$connection = Yii::$app->db;
$transaction = $connection->beginTransaction();
try {
    // 一些处理
    if ( false ) {
        throw new \Exception('异常');
    }

    $transaction->commit();

    return ['error' => 0, 'data' => []];
} catch ( \Exception $e ) {
    $transaction->rollBack();

    return ['error' => $e->getMessage(), 'data' => []];
}
```

<br/>
<pre style="background-color:#272822;color:#f8f8f2;font-family:'Source Code Pro';font-size:12.0pt;"><span style="color:#ffffff;">$connection </span><span style="color:#f72671;">= </span><span style="color:#ffffff;">Yii</span><span style="color:#f72671;">::</span><span style="color:#ffffff;font-style:italic;">$app</span><span style="color:#f72671;">-&gt;</span><span style="color:#ae81ff;font-weight:bold;">db</span><span style="color:#ffffff;">;<br></span><span style="color:#ffffff;">$transaction </span><span style="color:#f72671;">= </span><span style="color:#ffffff;">$connection</span><span style="color:#f72671;">-&gt;</span><span style="color:#ffffff;">beginTransaction</span>()<span style="color:#ffffff;">;<br></span><span style="color:#66d9ef;">try </span>{<br><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp; // 一些处理</span><br><span style="color:#ffffff;"><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp; </span></span><span style="color:#ffffff;"><span style="color:#ffffff;"><span style="color:#66d9ef;">if</span> ( </span></span><span style="color:#ffffff;"><span style="color:#ffffff;"><span style="color:#a6e22e;font-weight:bold;">false</span> ) {<br></span></span><span style="color:#ffffff;"><span style="color:#ffffff;"><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp;</span></span></span><span style="color:#ffffff;"><span style="color:#ffffff;"><span style="color:#ffffff;"><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="color:#ffffff;"><span style="color:#ffffff;"><span style="color:#ffffff;"><span style="color:#ffffff;"><span style="color:#66d9ef;">throw new </span>\<span style="color:#a6e22e;">Exception</span>(<span style="color:#ffde6b;">'</span><span style="color:#ffde6b;font-family:'宋体';">异常</span><span style="color:#ffde6b;">'</span>)<span style="color:#ffffff;">;</span></span> </span><br></span></span><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp; }</span><span style="color:#ffffff;"></span><br><br><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp; $transaction</span><span style="color:#f72671;">-&gt;</span><span style="color:#ffffff;">commit</span>()<span style="color:#ffffff;">;<br></span><span style="color:#ffffff;"><br></span><span style="color:#ffffff;">    </span><span style="color:#66d9ef;"><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp; </span>return </span><span style="color:#ffffff;">[</span><span style="color:#ffde6b;">'error' </span><span style="color:#f72671;">=&gt; </span><span style="color:#ae81ff;">0</span><span style="color:#ffffff;">, </span><span style="color:#ffde6b;">'data' </span><span style="color:#f72671;">=&gt; </span><span style="color:#ffffff;">[]];<br></span>} <span style="color:#66d9ef;">catch </span>( \<span style="color:#a6e22e;">Exception </span><span style="color:#ffffff;">$e </span>) {<br>    <span style="color:#ffffff;"><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp; </span>$transaction</span><span style="color:#f72671;">-&gt;</span><span style="color:#ffffff;">rollBack</span>()<span style="color:#ffffff;">;<br></span><span style="color:#ffffff;"><br></span><span style="color:#ffffff;">    </span><span style="color:#66d9ef;"><span style="color:#ffffff;">&nbsp;&nbsp;&nbsp; </span>return </span><span style="color:#ffffff;">[</span><span style="color:#ffde6b;">'error' </span><span style="color:#f72671;">=&gt; </span><span style="color:#ffffff;">$e</span><span style="color:#f72671;">-&gt;</span><span style="color:#ffffff;">getMessage</span>()<span style="color:#ffffff;">, </span><span style="color:#ffde6b;">'data' </span><span style="color:#f72671;">=&gt; </span><span style="color:#ffffff;">[]];<br></span>}</pre>


<br/><br/><br/><br/><br/>
### 参考资料
<http://www.w3school.com.cn/php/php_exception.asp>
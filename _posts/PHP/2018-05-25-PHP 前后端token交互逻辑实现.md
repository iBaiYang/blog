---
layout: post
categories: PHP
title: PHP 前后端token交互逻辑实现
meta: 前后端分离后，认证方式有多种，下面说一下选择使用token作为认证的解决方案。
---
* content
{:toc}

### 正文

前后端分离后，认证方式有多种，下面说一下选择使用token作为认证的解决方案，使用场景是嵌入式交互。

项目立项（假设项目名是项目ws），开发框架选择Yii2，token处理包选择lcobucci/jwt。

交互方式是：

bbs前端点击 ws按钮 ，向 bbs后端 发起请求，bbs后端 带上认证信息和请求的客户信息向 ws项目 获取token，ws项目 验证请求方信息，然后生成令牌 token，再把 token返回给 bbs后端，bbs后端 再把 token返回给 bbs前端，以后 bbs前端 就与 ws项目直接发生交互，每次交互都带上 token。

下面正式展开。

首先在ws项目的composer.json包管理中引入lcobucci/jwt，并更新：

```
"require": {
    "php": ">=7.0.0",
    "yiisoft/yii2": "=2.0.8",
    "lcobucci/jwt": "^3.2"
},
```

现在的前后端交互一般用form表单传递数据，但最好选用json格式，这样文件内容格式会更丰富，我们需要修改ws的component的request组件，加入json自动解析类：

```
'request' => [
    // !!! insert a secret key in the following (if it is empty) - this is required by cookie validation
    'cookieValidationKey' => 'X5fkO11SJRLNpeWi_bdkrTM_dKsQgSA-',
    'parsers'    =>  [
        'application/json' => 'yii\web\JsonParser',
        'text/json' => 'yii\web\JsonParser',
    ],
],
```

共同入口控制器中准备post请求的参数：

```
protected $global_post = [];  // post提交参数

public function init()
{
    parent::init();
    // post参数获取
    $req = Yii::$app->request;
    if ( !$req->isPost ) {
        return [
            'code' => 2001,
            'msg' => '提交方式错误',
            'data' => [],
        ];
    }
    $this->global_post = $req->post();
    foreach ( $this->global_post as $key => &$value )
    {
        $value = htmlspecialchars( trim( $value ) );
    }
}
```

ws的params文件中写入配置参数：

```
'params' => [
    'jwt' => [
        'iss' => 'https://ws.ali.com',  // 签发者
        'exp' => 0,  // 过期时间戳
        'sub' => 0,  //面向的用户
        'sur' => 86400,  // 时长
        'src' => 'bbs',  // 来源
        'aud' => 'http://bbs.ali.com', // 接收方
        'iat' => '', //签发时间
    ],
    
    'srcAccountInfo' => [
        'bbs' => [
            'appId' =>  'bbs',
            'appSecret' => 'bbs2013',
            'token' => 'bbs20130128'
        ],
        'tb' => [
            'appId' =>  'tb',
            'appSecret' => 'tb2013',
            'token' => 'tb20130128'
        ],
    ],
],
```

ws中对token签发和验证的逻辑封装：

```
namespace common\service;

use Lcobucci\JWT\Builder;
use Lcobucci\JWT\Signer\Hmac\Sha256;
use Lcobucci\JWT\Parser;
use Lcobucci\JWT\ValidationData;
use \Exception;
use Yii;

class LTokenService
{
    /**
     * 生成令牌
     * @param $from_type
     * @param $user_id
     * @return string
     */
    public static function createToken( $from_type, $user_id = 0 )
    {
        $jwt = Yii::$app->params['jwt'];
        $jwt['aud'] = Yii::$app->request->getUserIP();
        $jwt['jti'] = uniqid() . mt_rand(100000, 999999);
        $jwt['iat'] = time();
        $jwt['nbf'] = time();
        $jwt['exp'] = $jwt['iat'] + $jwt['sur'];
        $jwt['src'] = $from_type;
        $jwt['user_id'] = $user_id;

        $signer = new Sha256();
        $token = (new Builder())->setIssuer($jwt['iss'])  // 签发者
        ->setAudience( $jwt['aud'] )  //  接受者
        ->setId( $jwt['jti'], true )  // 唯一标识
        ->setIssuedAt( $jwt['iat'] )  // 签发时间
        ->setNotBefore( $jwt['nbf'])  // 过去时间不可用
        ->setExpiration( $jwt['exp'] )  // 截至时间
        ->set('user_id', $jwt['user_id'])  // 员工id
        ->set('src', $jwt['src'])  // 来源
        ->set('jti', $jwt['jti'])  // 唯一标识
        ->sign($signer, 'ali2013')  // 加盐字符串
        ->getToken();

//        $token->getHeaders(); // Retrieves the token headers
//        $token->getClaims(); // Retrieves the token claims

        return (string)$token;
    }

    /**
     * 检测Token是否过期与篡改
     * @param null $token
     * @return array
     * @throws Exception
     */
    public static function validateToken( $token = null )
    {
        $token = (new Parser())->parse($token); // Parses from a string
        $signer = new Sha256();
        if (!$token->verify($signer, 'ali2013')) {
            throw new Exception('签名不正确');
        }

        $jwt = Yii::$app->params['jwt'];
        $aud = Yii::$app->request->getUserIP();

        $validationData = new ValidationData();
        $validationData->setIssuer( $jwt['iss'] );
        $validationData->setAudience( $aud );  // 令牌异地检查
        $validationData->setId( $token->getClaim('jti') );  // 唯一标识

        if ( $token->validate($validationData) ) {
            return [
                'src' => $token->getClaim('src'),
                'user_id' => $token->getClaim('user_id'),
            ];
        } else {
            throw new Exception('令牌异地或过时');
        }
    }
}
```

现在bbs后端请求ws获取token：

> 请求地址：https://ws.ali.com/user/get-jwt-token

post方式，json格式请求：

```
{
    "src":"bbs",
    "appId":"bbs",
    "appSecret":"bbs2013",
    "userId":867,
}
```

ws的user/get-jwt-token接受逻辑：

```
use common\service\LTokenService;

public function actionGetJwtToken()
{
    $from_type = !empty($this->global_post['src']) ? $this->global_post['src'] : '';
    $appId = !empty($this->global_post['appId']) ? $this->global_post['appId'] : '';
    $appSecret = !empty($this->global_post['appSecret']) ? $this->global_post['appSecret'] : '';
    
    if ( empty($from_type) || empty($appId) || empty($appSecret) ) {
        return [
            'code' => 2010,
            'msg' => '提交参数不能为空',
            'data' => ,
        ];
    }
    
    $params_src = Yii::$app->params['srcAccountInfo'];
    if ( !isset( $params_src[ $from_type ] ) ) {
         return [
            'code' => 2015,
            'msg' => '来源项目未授权',
            'data' => ,
        ];
    }
    
    $systemData = $params_src[ $from_type ];
    if ( ($appId != $systemData['appId']) || ($appSecret != $systemData['appSecret']) ) {
        return [
            'code' => 2020,
            'msg' => '来源项目接入参数错误',
            'data' => ,
        ];
    }
    
    // 生成令牌
    $token = LTokenService::createToken( $from_type, user_id );
    
    return [
        'code' => 200,
        'msg' => 'ok',
        'data' => [
            'token' => $token,
        ],
    ];
}
```

bbs拿到token，以后请求都在head头信息中带上jwt-token。

看一下ws共同入口处的过滤操作：

```
public function beforeAction( $action )
{
    if ( $action->actionMethod != 'actionGetJwtToken' ) {
        /*****   检查令牌  ******/
        $jwtToken = Yii::$app->request->headers->get('jwt-token');
        if ( isset($jwtToken) ) {
            try {
                $res = LTokenService::validateToken( $jwtToken );
                
                $this->global_src = $res['src'];
                $this->global_user_id = $res['user_id'];
            } catch ( \Exception $e ) {
                $result = [
                    'code' => 401,
                    'msg' => '授权失败，请刷新页面后重新操作',
                    'data' => [],
                ];
                
                Yii::$app->response->format = Response::FORMAT_JSON;
                Yii::$app->response->data = $result;
                
                return false;
            }
        } else {
            return [
                'code' => 401,
                'msg' => '用户未授权',
                'data' => [],
            ];
        }
    }
    
    return parent::beforeAction($action);
}
```

<br/><br/><br/><br/><br/>
### 参考资料

<https://github.com/lcobucci/jwt/tree/3.2>
 
<https://laravel-china.org/articles/9122/composer-uses-jwt-to-generate-token-instances>

<http://www.ptbird.cn/jquery-test-jwt.html>

<http://www.cnblogs.com/zjutzz/p/5790180.html>

<https://blog.csdn.net/zy994914376/article/details/79579101>


---
layout: post
categories: PHP
title: PHP jwt使用实例
meta: jwt，全程 JSON WEB Token，是一种基于JSON的、用于在网络上声明某种主张的令牌（token）。
---
* content
{:toc}

### 正文

jwt，全程 JSON WEB Token，是一种基于JSON的、用于在网络上声明某种主张的令牌（token）。JWT通常由三部分组成: 头信息（header）, 消息体（payload）和签名（signature）。

php中，我们使用 lcobucci/jwt 这个库。
下面举个Yii2中使用的例子。浏览器访问指定地址获取token，以后访问时在header中带上token。

composer.json中require引入："lcobucci/jwt": "^3.2"

用user/get-jwt-token获取token，在这个方法中调用TokenService生成token：

```
<?php
namespace common\service;

use Lcobucci\JWT\Builder;
use Lcobucci\JWT\Signer\Hmac\Sha256;
use Lcobucci\JWT\Parser;
use Lcobucci\JWT\ValidationData;
use \Exception;
use Yii;

class LTokenService
{
    /**
     * 生成令牌
     * @param $from_type  来源
     * @param $department_id  部门
     * @param $position  职位
     * @param $worker_id  员工id
     * @return string
     */
    public static function createToken( $from_type, $department_id, $position, $worker_id )
    {
        $jwt = Yii::$app->params['jwt'];
        $jwt['aud'] = Yii::$app->request->getUserIP();
        $jwt['jti'] = uniqid() . mt_rand(100000, 999999);
        $jwt['iat'] = time();
        $jwt['nbf'] = time();
        $jwt['exp'] = $jwt['iat'] + $jwt['sur'];
        $jwt['src'] = $from_type;
        $jwt['worker_id'] = $worker_id;
        $jwt['department_id'] = $department_id;
        $jwt['position'] = $position;

        $signer = new Sha256();
        $token = (new Builder())->setIssuer($jwt['iss'])  // 签发者
        ->setAudience( $jwt['aud'] )  //  接受者
        ->setId( $jwt['jti'], true )  // 唯一标识
        ->setIssuedAt( $jwt['iat'] )  // 签发时间
        ->setNotBefore( $jwt['nbf'])  // 过去时间不可用
        ->setExpiration( $jwt['exp'] )  // 截至时间
        ->set('worker_id', $jwt['worker_id'])  // 员工id
        ->set('src', $jwt['src'])  // 来源
        ->set('department_id', $jwt['department_id'])  //部门
        ->set('position', $jwt['position'])  //职位
        ->set('jti', $jwt['jti'])  // 唯一标识
        ->sign($signer, 'test123456')  // 加盐字符串
        ->getToken();

//        $token->getHeaders(); // Retrieves the token headers
//        $token->getClaims(); // Retrieves the token claims

        return (string)$token;
    }

    /**
     * 检测Token是否过期与篡改
     * @param null $token
     * @return array
     * @throws Exception
     */
    public static function validateToken( $token = null )
    {
        $token = (new Parser())->parse($token); // Parses from a string
        $signer = new Sha256();
        if (!$token->verify($signer, 'test123456')) {
            throw new Exception('签名不正确');
        }

        $jwt = Yii::$app->params['jwt'];
        $aud = Yii::$app->request->getUserIP();

        $validationData = new ValidationData();
        $validationData->setIssuer( $jwt['iss'] );
//        $validationData->setAudience( $aud );  // 令牌异地检查
        $validationData->setId( $token->getClaim('jti') );  // 唯一标识

        if ( $token->validate($validationData) ) {
            return [
                'src' => $token->getClaim('src'),
                'department_id' => $token->getClaim('department_id'),
                'position' => $token->getClaim('position'),
                'worker_id' => $token->getClaim('worker_id'),
            ];
        } else {
            throw new Exception('令牌异地或过时');
        }
    }
}
```

配置参数：
```
'params' => [
    'jwt' => [
        'iss' => 'https://abc.test.com', // 签发者
        'exp' => 0, // 过期时间戳
        'sub' => 0,     //面向的用户
        'sur' => 86400,  // 过期事件一天
        'src' => 'lmn', // 来源
        'aud' => 'http://xyz.test.com', // 接收方
        'iat' => '', //签发时间
    ],
],
```

之后其他所有访问都检验token。所有控制器都继承自LController（包括user控制器），节选：
```
use Yii;
use yii\web\Controller;
use common\service\LTokenService;

class LController extends Controller
{
    protected $global_src = '';  // 来源项目
    protected $global_dpt_id = 0;  // 部门id
    protected $global_position = 0;  // 职位
    protected $global_wid = 0;  // 员工id,  worker.id

    public function beforeAction( $action )
    {
        $controllerName = $action->controller->id;
        $actionName = $action->id;

        if ( $action->actionMethod != 'actionGetJwtToken' && $action->controller->id != 'user' ) {
            /*****   检查令牌  ******/
            $jwtToken = Yii::$app->request->headers->get('jwt-token');
            if ( isset($jwtToken) ) {
                try {
                    $res = LTokenService::validateToken( $jwtToken );

                    $this->global_src = $res['src'];
                    $this->global_dpt_id = $res['department_id'];
                    $this->global_position = $res['position'];
                    $this->global_wid = $res['worker_id'];
                    $this->global_stu_id = $res['student_id'];
                } catch ( \Exception $e ) {
                    $result = [
                        'code' => 401,
                        'msg' => '授权失败，请刷新页面后重新操作',
                        'data' => [],
                    ];

                    Yii::$app->response->format = Response::FORMAT_JSON;
                    Yii::$app->response->data = $result;

                    return false;
                }
            } else {
                return $this->ajaxReturn( LError::ERROR, '用户未授权' );
            }
        }

        return parent::beforeAction($action);
    }
}
```


<br/><br/><br/><br/><br/>
### 参考资料

<https://blog.csdn.net/HobHunter/article/details/78524922>

<https://github.com/lcobucci/jwt/blob/3.2/README.md#basic-usage>

<https://blog.csdn.net/maxsky/article/details/80036512>

初步理解JWT并实践使用 <https://www.jianshu.com/p/2fdc20a42c41>

<https://www.jianshu.com/p/af8360b83a9f>

<https://cnodejs.org/topic/5b0c4a7b8a4f51e140d942fc>